---
title: "Central Arizona-Phoenix Bird Species Dynamics - Analyze Model Results"
author: "Jeffrey Haight"
date: "`r Sys.Date()`"
output:
  word_document: default
  html_document: default
---

```{r setup, set.seed(54321), include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE, 
  include = TRUE,
  cache = TRUE
  )
rm(list = ls())
gc()
```

```{r packages, message = FALSE, echo = TRUE, warning = FALSE}
  library(tidyverse)
  library(beepr)  # for notifying you when some code is  done running

# for statistical modeling
  library(performance)  # for checking model performance (multicollinearity, VIF, overdispersion, etc.)
  library(insight)      # for extracting a lot of useful model information, using functions like 'get_variance()'
  library(lme4)
  library(glmmTMB)
  library(lmerTest)     # for getting p-values out of the lmer models
  library(MuMIn)        # for calculating R^2, among other things
  library(vegan)        # for multivariate community analyses
  # library(rjags)
  library(jagsUI)       # for running Bayesian models in JAGS
  library(mgcv)         # for GAM(M)s
  library(itsadug)      # for GAMM plotting

# for plotting
# library(ggplot2)      # should already be in the 'tidyverse'
  library(ggpubr)       # for adding correlations and p-values to ggplot
  library(ggeffects)    # for plotting glmm effects in ggplot
  library(ggcorrplot)   # for correlation plots
  library(GGally)       # similar to ggcorrplot
  library(gghighlight)  # for highlighting groups in ggplot
  library(RColorBrewer)
  library(ggridges)
  library(scales)
```

# Import Data
```{r import model input data, include = FALSE}
list.files("~/GitHub/caplter-dynamicbirds/data/input")

# This contains data assembled by the '3_ModelDataFormatting_caplter-dynamicbirds.Rmd' file
load("~/GitHub/caplter-dynamicbirds/data/input/modelinputs_dynamicbirds2025.RData")

# load("~/Github/caplter-dynamicbirds/data/input/jagsinputs_CAPbirds2024.RData")  # the bundled BUGS data

data.spp <- data.spp %>% filter(code %in% dimnames(ysum.model)[[2]])

      
```


### Community occupancy model results
As with many Bayesian occupancy models, the data files needed to contain them are too large to share via GitHub. These files can be reproduced by running the code in the file _4_CommunityOccupancyModel_caplter-dynamicbirds.Rmd_ and can be made available upon request to the corresponding author (Jeffrey Haight, jdhaight.eco@gmail.com). Parameters in the 'msum' object are also shared as a supplementary dataset _DatasetS1_summarytable_occupancymodelparameters.xlsx_
```{r import model results}
tmp <- readRDS("G:/Shared drives/CAP USE Postdoc/projects/DynamicBirds/data/output/MSOM_CAPbirds_spring_40ksamp.rds")
msum <- read.csv("G:/Shared drives/CAP USE Postdoc/projects/DynamicBirds/data/output_summary/MSOM_CAPbirds_spring_summary40ksamp.csv")


# For illustrative/plotting purposes, we may want to take a subset of samples, to save on processing
    set.seed(54321)
    nsamp <- 10000   # 1/4 of the total 40K samples
    samp <- sample(1:nrow(tmp$beta.comm), size = nsamp, replace = FALSE)

```
```{r review model results}

msum %>% as.data.frame() %>% filter(Rhat < 1.05)
msum %>% as.data.frame() %>% filter(Rhat >= 1.05)
# msum %>% as.data.frame() %>% filter(f > 0.95)
# msum %>% as.data.frame() %>% filter(f > 0.85)

data.spp %>% filter(code %in% spp.model) %>% arrange(code)


apply(tmp$beta.comm, 2, quantile, probs = c(0.05, 0.5, 0.95))
apply(tmp$delta.traits, c(2,3), quantile, probs = c(0.05, 0.5, 0.95))

# Which are the largest species?
data.spp %>% arrange(desc(Mass))
```
*With land surface temperature was used as a covariate (and unknown species were included):*
Substantial environmental effects at the community level, except for the urbanization X temperature interaction (except there was for certain species).
Temperature: positive, with a _positive_ interaction
Larger species: rarer, more negatively affected by urbanization, temperature, 
Higher HWI: none
Diet specialization: none

*With daily minimum air temperature was the occupancy covariate (and unknown species were excluded):*
All environmental effects were substantial at the community-level, though not quite the vegetation interaction (f = 0.930)
Temperature: positive, but with a _negative_ interaction
Larger species: rarer (f = 0.934), more negatively affected by temperature and by urbanization at hotter sites, more positively affected by vegetation 
Higher HWI: none
Diet specialization: none

*With the random effect of year accounted for:*
Larger species: rarer (f = 0.919), more negatively affected by temperature (f = 0.909) and by urbanization at hotter sites, more positively affected by vegetation 




# Review Effects & Create Response Groups
First, we may consider the random effects of 'year'. Which species were just more or less likely to occur in a given year?
```{r}
# which species were randomly more common in different years?
msum %>% as.data.frame() %>% 
  filter(grepl("year", X)) %>% 
  filter(f > 0.95)

# A  bunch of (~44) species were more common than average during the first year (2001)
# ~11 were more (and 1 was less) common during year 2 (2002)
# ~12 were more common during year 5 (2006)

# During the other years 3 through 14, more of the year effects were negative, 
# corresponding to species becoming less common than they were 

```




```{r separate model effects}
beta.comm <- apply(tmp$beta.comm, 2, quantile, probs = c(0.025, 0.5, 0.975))

beta.species <- apply(tmp$beta.species, MARGIN = c(2, 3), quantile, probs = c(0.025, 0.5, 0.975))


m.effects <- data.frame(
  "spp" = rep(dimnames(ysum.model)[[2]], each = dim(tmp$beta.species)[1]),
  "iter" = rep(1:dim(tmp$beta.species)[1], dim(ysum.model)[[2]]),
  "effect_urb" = matrix(tmp$beta.species[,2,]),
  "effect_temp" = matrix(tmp$beta.species[,3,]),
  "effect_tempint" = matrix(tmp$beta.species[,4,]),
  "effect_veg" = matrix(tmp$beta.species[,5,]),
  "effect_vegint" = matrix(tmp$beta.species[,6,]),
  "theta" = matrix(tmp$theta.species) %>% plogis()
) %>% mutate(
  mean_effect_urb = mean(effect_urb), 
  median_effect_urb = median(effect_urb),
  low95_effect_urb = quantile(effect_urb, probs = c(0.025)),
  upp95_effect_urb = quantile(effect_urb, probs = c(0.975)),
  low90_effect_urb = quantile(effect_urb, probs = c(0.05)),
  upp90_effect_urb = quantile(effect_urb, probs = c(0.95)),
  
  mean_effect_veg = mean(effect_veg), 
  median_effect_veg = median(effect_veg),
  low95_effect_veg = quantile(effect_veg, probs = c(0.025)),
  upp95_effect_veg = quantile(effect_veg, probs = c(0.975)),
  low90_effect_veg = quantile(effect_veg, probs = c(0.05)),
  upp90_effect_veg = quantile(effect_veg, probs = c(0.95)),
  
  mean_effect_vegint = mean(effect_vegint), 
  median_effect_vegint = median(effect_vegint),
  low95_effect_vegint = quantile(effect_vegint, probs = c(0.025)),
  upp95_effect_vegint = quantile(effect_vegint, probs = c(0.975)),
  low90_effect_vegint = quantile(effect_vegint, probs = c(0.05)),
  upp90_effect_vegint = quantile(effect_vegint, probs = c(0.95)),
  
  mean_effect_temp = mean(effect_temp), 
  median_effect_temp = median(effect_temp),
  low95_effect_temp = quantile(effect_temp, probs = c(0.025)),
  upp95_effect_temp = quantile(effect_temp, probs = c(0.975)),
  low90_effect_temp = quantile(effect_temp, probs = c(0.05)),
  upp90_effect_temp = quantile(effect_temp, probs = c(0.95)),
  
  mean_effect_tempint = mean(effect_tempint), 
  median_effect_tempint = median(effect_tempint),
  low95_effect_tempint = quantile(effect_tempint, probs = c(0.025)),
  upp95_effect_tempint = quantile(effect_tempint, probs = c(0.975)),
  low90_effect_tempint = quantile(effect_tempint, probs = c(0.05)),
  upp90_effect_tempint = quantile(effect_tempint, probs = c(0.95)),
  
  mean_theta = mean(theta), 
  median_theta = median(theta),
  low95_theta = quantile(theta, probs = c(0.025)),
  upp95_theta = quantile(theta, probs = c(0.975)),
  low90_theta = quantile(theta, probs = c(0.05)),
  upp90_theta = quantile(theta, probs = c(0.95)),
  
  .by = spp) %>% 
  
  # add 'order by urbanization effect'
  arrange(median_effect_urb) %>% 
  mutate(order_urbeffect = as.factor(rep(1:dim(tmp$beta.species)[3], each = dim(tmp$beta.species)[1])), 
         spp = as.factor(spp)) %>% 
  # add 'order by temperature effect'
  arrange(median_effect_temp) %>% 
  mutate(order_tempeffect = as.factor(rep(1:dim(tmp$beta.species)[3], each = dim(tmp$beta.species)[1])), 
         spp = as.factor(spp)) %>% 
  # add 'order by vegetation effect'
  arrange(median_effect_veg) %>% 
  mutate(order_vegeffect = as.factor(rep(1:dim(tmp$beta.species)[3], each = dim(tmp$beta.species)[1])), 
         spp = as.factor(spp)) %>% 
  
  # add 'order by theta'
  arrange(median_theta) %>% 
  mutate(order_theta = as.factor(rep(1:dim(tmp$theta.species)[2], each = dim(tmp$theta.species)[1])), 
         spp = as.factor(spp)) %>% 
  
  # join with species traits of interest
  left_join((data.spp %>% select(code, common_name, sci_name,
         # cultural_niche, popularity, congruence,  # data from Schuetz & Johnston 2019 that are not being examined anymore
         birdofprey, hummingbird, woodpecker, waterfowl, shorebirds, waterbird_guild, 
         SGCN, ESA, MEXFED, USFS, BLM, 
         Mass, Hand.Wing.Index, dietdiv)), by = c("spp" = "code")
         ) # could also join with a subset of data.spp

```
```{r summarize stats by species}

# a second data frame that will have the summary stats of the estimates  
(
  m.effects.sum <- m.effects %>% group_by(spp) %>% slice(1) %>% 
    select(-c(iter#, 
              #effect_urb, effect_temp, effect_tempint, effect_veg, effect_vegint, 
              )) %>% 
    ungroup() %>% arrange(order_urbeffect) %>% arrange(order_tempeffect) %>%
    # add the number of observations of each species (across all sites*occasions)
    arrange(spp) %>% 
    mutate(Nobs = apply(ysum.model, MARGIN = c(2), FUN = 'sum', na.rm = TRUE))
)
dim(tmp$theta.species)[2]

# add a few more rankings by traits, for plotting purposes
m.effects.sum <- m.effects.sum %>% 
  arrange(Mass) %>% mutate(order_mass = as.factor(1:nrow(m.effects.sum))) %>%
  arrange(Hand.Wing.Index) %>% mutate(order_HWI = as.factor(1:nrow(m.effects.sum))) %>%
  arrange(dietdiv) %>% mutate(order_dietdiv = as.factor(1:nrow(m.effects.sum)))
```

```{r list species by substantial effects and traits}

# Urbanization relationships
  # which species had positive relationships with impervious surface
  spp.urb.positive <- m.effects.sum %>% # filter(low95_effect_urb > 0) %>%
        filter(low90_effect_urb > 0) %>% pull(common_name) %>% sort()  # mostly introduced and/or common species
  spp.urb.negative <- m.effects.sum %>% # filter(upp95_effect_urb < 0) %>% 
    filter(upp90_effect_urb < 0) %>% pull(common_name) %>% sort() 
  spp.urb.neutral <- m.effects.sum %>% filter(!common_name %in% c(spp.urb.positive, spp.urb.negative)) %>% 
    pull(common_name) %>% sort() 
  
# Vegetation relationships
  # negative relationships? 
  spp.veg.negative <- m.effects.sum %>% #filter(upp95_effect_veg < 0) %>%
    filter(upp90_effect_veg < 0)  %>% pull(common_name) %>% sort()
  spp.vegint.negative <- m.effects.sum %>% #filter(upp95_effect_vegint < 0) %>% 
    filter(upp90_effect_vegint < 0)%>% pull(common_name) %>% sort()
  # positive relationships
  spp.veg.positive <- m.effects.sum %>% #filter(low95_effect_veg > 0) %>% 
      filter(low90_effect_veg > 0) %>% pull(common_name) %>% sort()  # includes a number of waterbirds
  spp.vegint.positive <- m.effects.sum %>% #filter(low95_effect_vegint > 0) %>% 
      filter(low90_effect_vegint > 0) %>% pull(common_name) %>% sort() # includes species with both positive *and* negative 
  
# Temperature relationships
  # negative relationships? 
  spp.temp.negative <- m.effects.sum  %>% #filter(upp95_effect_temp < 0) %>% 
      filter(upp90_effect_temp < 0) %>% pull(common_name) %>% sort()  # only a couple have outright negative relationships with temperature
  spp.tempint.negative <- m.effects.sum %>% #filter(upp95_effect_tempint < 0) %>% 
      filter(upp90_effect_tempint < 0) %>% pull(common_name) %>% sort()  # several have negative urbanization interactions with temperature
  
  # positive relationships?
  spp.temp.positive <- m.effects.sum  %>% # filter(low95_effect_temp > 0) %>% 
    filter(low90_effect_temp > 0) %>% pull(common_name) %>% sort()  # a signficant number of desert species here
  spp.tempint.positive <- m.effects.sum  %>% #filter(low95_effect_tempint > 0) %>% 
    filter(low90_effect_tempint > 0) %>% pull(common_name) %>% sort()

# species not strongly affected by anything
  # these are species whose presence is not highly sensitive to the environmental conditions we included
  # i.e., environmental filtering is not necessarily the main mechanism for community assembly here
  spp.neutral <- data.spp %>% filter(!common_name %in% c(spp.urb.negative, spp.urb.positive,
                                          spp.temp.negative, spp.tempint.negative,  
                                          spp.temp.positive, spp.tempint.positive,
                                          spp.veg.negative, spp.vegint.negative,
                                          spp.veg.positive, spp.vegint.positive  
                                          )) %>% pull(common_name) %>% sort()
# note that a lot of waterbirds are in here

  
# Species Trends (based on the 'theta' parameter)
  # theta > 1 means the species is becoming more common (is even more likely to be present )
  # m.effects.sum %>% filter(low95_theta > 1) %>% pull(common_name) %>% sort()
  # m.effects.sum %>% filter(upp95_theta < 1) %>% pull(common_name) %>% sort()
  
# list the Arizona SGCNs
  (spp.sgcn <- m.effects.sum %>% filter(SGCN %in% c("1", "2", "3")) %>% pull(common_name))
  

# Add this information to the summary table of species relationships, using the columns from the table with all iterations
m.effects.sum$effect_urb <- as.character(m.effects.sum$effect_urb)
m.effects.sum$effect_temp <- as.character(m.effects.sum$effect_temp)
m.effects.sum$effect_tempint <- as.character(m.effects.sum$effect_tempint)
m.effects.sum$effect_veg <- as.character(m.effects.sum$effect_veg)
m.effects.sum$effect_vegint <- as.character(m.effects.sum$effect_vegint)

# effect_urb, effect_temp, effect_tempint, effect_veg, effect_vegint
m.effects.sum[which(m.effects.sum$common_name %in% spp.urb.negative),]$effect_urb <- "Avoider"
m.effects.sum[which(!m.effects.sum$common_name %in% c(spp.urb.negative, spp.urb.positive)),]$effect_urb <- "Neutral"
m.effects.sum[which(m.effects.sum$common_name %in% spp.urb.positive),]$effect_urb <- "Adapter"

m.effects.sum[which(m.effects.sum$common_name %in% spp.temp.negative),]$effect_temp <- "Negative"
m.effects.sum[which(!m.effects.sum$common_name %in% c(spp.temp.negative, spp.temp.positive)),]$effect_temp <- "Neutral"
m.effects.sum[which(m.effects.sum$common_name %in% spp.temp.positive),]$effect_temp <- "Positive"

m.effects.sum[which(m.effects.sum$common_name %in% spp.tempint.negative),]$effect_tempint <- "Negative"
m.effects.sum[which(!m.effects.sum$common_name %in% c(spp.tempint.negative, spp.tempint.positive)),]$effect_tempint <- "Neutral"
m.effects.sum[which(m.effects.sum$common_name %in% spp.tempint.positive),]$effect_tempint <- "Positive"

m.effects.sum[which(m.effects.sum$common_name %in% spp.veg.negative),]$effect_veg <- "Negative"
m.effects.sum[which(!m.effects.sum$common_name %in% c(spp.veg.negative, spp.veg.positive)),]$effect_veg <- "Neutral"
m.effects.sum[which(m.effects.sum$common_name %in% spp.veg.positive),]$effect_veg <- "Positive"

m.effects.sum[which(m.effects.sum$common_name %in% spp.vegint.negative),]$effect_vegint <- "Negative"
m.effects.sum[which(!m.effects.sum$common_name %in% c(spp.vegint.negative, spp.vegint.positive)),]$effect_vegint <- "Neutral"
m.effects.sum[which(m.effects.sum$common_name %in% spp.vegint.positive),]$effect_vegint <- "Positive"

# add a number corresponding to a species' order in the model input/output data
m.effects.sum <- m.effects.sum %>% arrange(spp) %>% mutate(spp_num = 1:length(spp))


# summarize whether a species was 'dynamic' at all
  m.effects.sum$dynamic <- m.effects.sum$effect_urb
  m.effects.sum[which(m.effects.sum$common_name %in% c(
    spp.temp.negative, spp.temp.positive, spp.tempint.negative, spp.tempint.positive,
    spp.veg.negative, spp.veg.positive, spp.vegint.negative, spp.vegint.positive
    )),]$dynamic <- "Y"
  m.effects.sum$dynamic[which(m.effects.sum$dynamic != "Y")] <- "N"

# finally, the tricky part: describing the predicted effects of higher temperature and drier conditions (less green vegetation)
  m.effects.sum$effect_highertemp <- rep(NA, nrow(m.effects.sum))
  m.effects.sum$effect_lessgreen <- rep(NA, nrow(m.effects.sum))
  
  m.effects.sum[which(m.effects.sum$effect_tempint == "Negative"),]$effect_highertemp <- "Less urban-associated"
  # m.effects.sum[which(m.effects.sum$effect_tempint == "Positive"),] # none present
  m.effects.sum[which(m.effects.sum$effect_temp == "Negative"),]$effect_highertemp <- "Lower overall occupancy"
  m.effects.sum[which(m.effects.sum$effect_temp == "Positive"),]$effect_highertemp <- "Higher overall occupancy"
  
  m.effects.sum[which(m.effects.sum$effect_vegint == "Negative" & m.effects.sum$effect_veg == "Positive"),]$effect_lessgreen <- "More urban-associated, lower overall occupancy"
  m.effects.sum[which(m.effects.sum$effect_vegint == "Negative" & m.effects.sum$effect_veg == "Neutral"),]$effect_lessgreen <- "More urban-associated"
  
  m.effects.sum[which(m.effects.sum$effect_vegint == "Positive" & m.effects.sum$effect_veg == "Positive"),]$effect_lessgreen <- "Less urban-associated, lower overall occupancy"
  m.effects.sum[which(m.effects.sum$effect_vegint == "Positive" & m.effects.sum$effect_veg == "Neutral"),]$effect_lessgreen <- "Less urban-associated"
  
  m.effects.sum[which(m.effects.sum$effect_vegint == "Neutral" & m.effects.sum$effect_veg == "Positive"),]$effect_lessgreen <- "Lower overall occupancy"
   m.effects.sum[which(m.effects.sum$effect_vegint == "Neutral" & m.effects.sum$effect_veg == "Negative"),]$effect_lessgreen <- "Higher overall occupancy"
  
  m.effects.sum %>% select(c(common_name, 
                             effect_urb, effect_temp, effect_tempint, effect_veg, 
                             effect_vegint, effect_highertemp, effect_lessgreen))
data.spp
```

```{r export the species summary data}

# reorder the columns to put the species names/traits up front
m.effects.sum <- m.effects.sum %>% select(c( 
  spp, spp_num, common_name, sci_name, Nobs, 
  #cultural_niche, popularity, congruence, 
  birdofprey, hummingbird, woodpecker, waterfowl, shorebirds, waterbird_guild, 
  SGCN, ESA, MEXFED, USFS, BLM, 
  Mass, Hand.Wing.Index, dietdiv, 
  effect_urb, effect_temp, effect_tempint, effect_veg, effect_vegint, 
  dynamic, effect_highertemp, effect_lessgreen,
  mean_effect_urb ,median_effect_urb, 
  low95_effect_urb, upp95_effect_urb,
  low90_effect_urb, upp90_effect_urb, 
  mean_effect_temp, median_effect_temp,
  low95_effect_temp, upp95_effect_temp,
  low90_effect_temp, upp90_effect_temp, 
  mean_effect_tempint, median_effect_tempint ,
  low95_effect_tempint, upp95_effect_tempint,
  low90_effect_tempint, upp90_effect_tempint, 
  mean_effect_veg, median_effect_veg, 
  low95_effect_veg, upp95_effect_veg,
  low90_effect_veg, upp90_effect_veg,
  mean_effect_vegint, median_effect_vegint,
  low95_effect_vegint, upp95_effect_vegint,
  low90_effect_vegint, upp90_effect_vegint, 
  mean_theta ,median_theta, 
  low95_theta, upp95_theta,
  low90_theta, upp90_theta, 
  order_urbeffect, order_tempeffect, order_vegeffect, 
  order_mass, order_HWI, order_dietdiv, order_theta
  ) ) %>% arrange(spp)


# export
write.csv(m.effects.sum, 
  "~/Github/caplter-dynamicbirds/data/MSOMoutput_specieseffectsummary.csv", row.names = FALSE)

# m.effects.sum %>% arrange(order_theta)
```


```{r species affected by urbanization}
# Species negatively affected by urbanization on its own
data.spp %>% filter(common_name %in% spp.urb.negative)

# Species positively affected by urbanization on its own
data.spp %>% filter(common_name %in% spp.urb.positive)

# Species not strongly associated with urbanization in one way or another
data.spp %>% filter(!common_name %in% c(spp.urb.negative, spp.urb.positive))

```


```{r species affected by temperature}
# Species negatively affected by temperature and its interaction with urbanization
data.spp %>% filter(common_name %in% spp.temp.negative)
data.spp %>% filter(common_name %in% spp.tempint.negative) %>% arrange(desc(Mass))

# Species positively affected by temperature and its interaction with urbanization
data.spp %>% filter(common_name %in% spp.temp.positive)
data.spp %>% filter(common_name %in% spp.tempint.positive) 
data.spp %>% filter(common_name %in% c(spp.temp.positive, spp.tempint.positive))

# Species not strongly associated with temperature in one way or another
data.spp %>% filter(!common_name %in% c(spp.temp.negative, spp.temp.positive, spp.tempint.negative, spp.tempint.positive))


# Temperature relationships of species negatively associated with urbanization
  
  data.spp %>% filter(common_name %in% spp.urb.negative) %>% filter(common_name %in% spp.temp.negative)    #  
  data.spp %>% filter(common_name %in% spp.urb.negative) %>% filter(common_name %in% spp.tempint.negative) # 
  data.spp %>% filter(common_name %in% spp.urb.negative) %>% filter(common_name %in% spp.temp.positive)    # 
  data.spp %>% filter(common_name %in% spp.urb.negative) %>% filter(common_name %in% spp.tempint.positive) # 
  data.spp %>% filter(common_name %in% spp.urb.negative) %>% filter(common_name %in% c(spp.temp.positive,
                                                                                       spp.tempint.positive)) # 
  # The Bald Eagle sensitive to urbanization, but especially when temperatures are higher
  # 17 species with negative urbanization relationships had positive relationships with temperature 
  # (either higher occupancy or a less)

# Temperature relationships of species positively associated with urbanization
  data.spp %>% filter(common_name %in% spp.urb.positive) %>% filter(common_name %in% spp.temp.negative)    # 
  data.spp %>% filter(common_name %in% spp.urb.positive) %>% filter(common_name %in% spp.tempint.negative) # 
  data.spp %>% filter(common_name %in% spp.urb.positive) %>% filter(common_name %in% c(spp.temp.positive) )   # 
  data.spp %>% filter(common_name %in% spp.urb.positive) %>% filter(common_name %in% spp.tempint.positive) # 
  data.spp %>% filter(common_name %in% spp.urb.positive) %>% filter(common_name %in% c(spp.temp.positive,
                                                                                       spp.tempint.positive) ) # 

  # 11 species are sensitive to urbanization but are more associated with warmer temperatures
```

```{r species affected by vegetation}
# Species negatively affected by vegetation  and its interaction with urbanization
data.spp %>% filter(common_name %in% spp.veg.negative) %>% arrange(desc(MassLog))
data.spp %>% filter(common_name %in% spp.vegint.negative)

# Species positively affected by vegetation  and its interaction with urbanization
data.spp %>% filter(common_name %in% spp.veg.positive) %>% arrange(desc(MassLog))
data.spp %>% filter(common_name %in% spp.vegint.positive)
data.spp %>% filter(common_name %in% c(spp.veg.positive, spp.vegint.positive))

# Species not strongly associated with vegetation in one way or another
data.spp %>% filter(!common_name %in% c(spp.veg.negative, spp.veg.positive, spp.vegint.negative, spp.vegint.positive)) 

  data.spp %>% filter(common_name %in% spp.urb.negative) %>% filter(common_name %in% spp.veg.negative)    #
  data.spp %>% filter(common_name %in% spp.urb.negative) %>% filter(common_name %in% spp.vegint.negative) #  
  # ^ Species with negative vegetation effects are generally those that also have negative urbanization effects
  data.spp %>% filter(common_name %in% spp.urb.negative) %>% filter(common_name %in% spp.veg.positive)    # 
  data.spp %>% filter(common_name %in% spp.urb.negative) %>% filter(common_name %in% spp.vegint.positive) # 
  
  data.spp %>% filter(common_name %in% spp.urb.positive) %>% filter(common_name %in% spp.veg.negative)    # 
  data.spp %>% filter(common_name %in% spp.urb.positive) %>% filter(common_name %in% spp.vegint.negative) # 0
  # no urban-adapted species with negative vegetation effect
  data.spp %>% filter(common_name %in% spp.urb.positive) %>% filter(common_name %in% spp.veg.positive)    # 
  data.spp %>% filter(common_name %in% spp.urb.positive) %>% filter(common_name %in% spp.vegint.positive) # 
  data.spp %>% filter(common_name %in% spp.urb.positive) %>% filter(common_name %in% c(spp.veg.positive, spp.vegint.positive))  # 10 species
  # species with positive urbanization effects have more positive vegetation effects 
```
```{r uncertain species not strongly associated with anything}
data.spp %>% filter(common_name %in% spp.neutral)

# let's investigate this a bit
# how many of these are neutral just because they're probably just to rare to establish substantial relationships?
spp.num.neutral <- which(spp.model %in% (data.spp %>% filter(common_name %in% spp.neutral) %>% pull(code))) # the numbers of the "neutral" species

(
  beta.neutral <- data.frame(
  "spp" = spp.neutral,
  # "code" = data.spp %>% filter(common_name %in% spp.neutral) %>% pull(code),
  tmp$beta.species[,,spp.num.neutral] %>% apply(MARGIN = c(2, 3), mean) %>% t()
  ) %>%
  mutate(   # inverse-logit transform the intercept to get psi
    psi = plogis(X1)
  ) %>% arrange(desc(psi))
)

# some of these species with the lowest occupancy are also VERY abundant at the sites where they are found, especially the waterbirds
# a bit of a limitation of occupancy modeling I suppose

```

# Visualize Traits
```{r APPENDIX FIGURE trait variation}
cor(data.spp$MassLog, data.spp$dietdiv)
cor(data.spp$MassLog, data.spp$Hand.Wing.Index)
plot.traits <- data.spp %>%
    ggplot(aes(x = log10(Mass), y = Hand.Wing.Index, color = dietdiv)) +
    # geom_text_repel(aes(label = code), force = 1, size = 3, max.overlaps = 10) +
    theme_classic(base_size = 12) +
    # scale()
    geom_point(size = 1, color = "gray50") +
    geom_point(size = 0.9) +
    # geom_smooth(method = "lm") +
    scale_color_viridis(option = "viridis") +
    scale_x_continuous(trans = "log10",
         breaks = log10(c(1, 3, 5, 10, 25, 50, 100, 250, 500, 1000, 2500, 5000)),
         labels = c("1","3", "5", "10", "25","50","100","250", "500", "1000","2500","5000")) +
    labs(x = "Body Mass (kg)", y = "Hand-Wing Index", color = "Diet Diversity\nIndex (H')") +
    theme(axis.text.x = element_text(face = "bold", angle = -30, vjust = -0.3), 
          axis.text.y = element_text(face = "bold"), 
          # legend.position = "none",
          legend.title = element_text(face = "bold"),
          legend.text = element_text(face = "bold"),
          # axis.ticks = element_blank(),
          axis.title.x = element_text(face = "bold", size = 12), 
          axis.title.y = element_text(face = "bold", size = 12))
  plot.traits
  
  ggsave("~/Github/caplter-dynamicbirds/figures/appendix/traitdistribution_SizeVsDiet.png",
         plot.traits,
         width = 6,
         height = 3,
         units = "in",
         dpi = 300)
  
```
  
# Visualize Model Parameters
```{r autoregression coefficient}
plot.effects <- m.effects.sum %>%
ggplot(aes(x = as.factor(order_theta), y = median_theta, color = median_theta)) +
  theme_classic() +
  geom_hline(yintercept = 0, color = "black", linetype = "dashed") +
  geom_linerange(aes(ymin = low95_theta, ymax = upp95_theta), 
                 width = 0.4, size = 0.4, alpha = 1)+
  geom_point(pch = 16, size = 1) +   #pch = 21, fill = NA
  # scale_color_viridis_c(option = "plasma", direction = -1) +
  # scale_color_manual(values = c("#E97335","gray50","#1F78B4" ), labels = c("Urban Avoider", "Urban Uncertain", "Urban Adapter")) +   # values = brewer.pal(8,"Set2")[c(2,6,1)]
  scale_x_discrete(labels = m.effects.sum$spp) +
  labs(x = "Species", y = "Theta") + 
  # gghighlight(SGCN %in% c("1", "2", "3")) +
  # gghighlight(spp %in% c(#"GAQU", "CACW", "ANHU", "COHU", "GTGR"
  #                        "BBWD")) +
  # gghighlight(spp %in% c(m.effects.sum %>% filter(low95_effect_urb > 0) %>% pull(spp))) +
  coord_flip() +
  theme(
    # legend.position = "none",
    legend.position = "top",
    # axis.text.x = element_text(angle = 30, vjust = 1, hjust=1, size = 14),
    axis.text.y = element_blank(),
    axis.text.x = element_text(size = 14),
    axis.title = element_text(face = "bold", size = 16),
    # legend.title = element_text(face = "bold", size = 16),
    legend.title = element_blank(),
    legend.text = element_text(size = 14)
  ) 
plot.effects

m.effects.sum %>% arrange(order_theta)
```

```{r FIGURE urbanization effects}
# Density plots to depict posterior distributions
    # m.effects %>% #filter(spp %in% c("BETH")) %>%
    # ggplot(aes(x = effect_urb, y = order_urbeffect, group = order_urbeffect)) +
    #   theme_classic() +
    #   geom_vline(xintercept = 0, color = "red", linetype = "dashed") +
    #   geom_density_ridges(alpha = 0.5, color = "transparent") +
    #   scale_y_discrete(labels = m.effects.sum$spp) +
    #   # geom_pointrange(aes(x = median_effect_urb, xmin = low95_effect_urb, xmax = upp95_effect_urb)) +
    #   labs(x = "Relationship with Urbanization (ENDISI)", y = "Species (Alpha-code)") + 
    #   # coord_flip() +
    #   coord_cartesian(xlim = c(-2.5, 2.5))+
    #   # gghighlight(SGCN %in% c("1", "2", "3")) +
    #   # gghighlight(spp %in% c("BETH")) +
    #   theme(
    #     axis.text.y = element_blank()
    #   )

# Point and range plots
plot.effects <- m.effects.sum %>%
ggplot(aes(x = as.factor(order_urbeffect), y = median_effect_urb, color = effect_urb)) +
  theme_classic() +
  geom_hline(yintercept = 0, color = "black", linetype = "dashed") +
  geom_linerange(aes(ymin = low90_effect_urb, ymax = upp90_effect_urb), 
                 width = 0.4, size = 0.4, alpha = 1)+
  geom_point(pch = 16, size = 1) + 
  scale_color_manual(values = c("#E97335","gray50","#1F78B4" ), labels = c("Urban Avoider", "Urban-neutral", "Urban Adapter")) +
  scale_x_discrete(labels = m.effects.sum$spp) +
  labs(x = "Species", y = "Relationship with Urbanization (ENDISI)")+
  coord_flip() +
  theme(
    # legend.position = "none",
    legend.position = "top",
    # axis.text.x = element_text(angle = 30, vjust = 1, hjust=1, size = 14),
    axis.text.y = element_blank(),
    axis.text.x = element_text(size = 14),
    axis.title = element_text(face = "bold", size = 16),
    # legend.title = element_text(face = "bold", size = 16),
    legend.title = element_blank(),
    legend.text = element_text(size = 14)
  ) 
plot.effects

ggsave("~/Github/caplter-dynamicbirds/figures/effect_urb.png",
       plot.effects,
       width = 7,
       height = 4,
       units = "in",
       dpi = 300)

```





### Urbanization vs. Temperature
```{r urb vs temp effects by urb}
# m.effects %>% filter(SGCN %in% c("1", "2", "3")) %>%
# ggplot(aes(x = effect_urb, y = order_urbeffect, group = order_urbeffect, fill = as.factor(SGCN))) +
#   theme_classic() +
#   geom_vline(xintercept = 0, color = "red", linetype = "dashed") +
#   geom_density_ridges(alpha = 0.5, color = "transparent") +
#   scale_y_discrete(labels = m.effects.sum$spp) +
#   geom_pointrange(aes(x = median_effect_temp, xmin = low90_effect_temp, xmax = upp90_effect_temp)) +
#   labs(x = "Covariate Effect", y = "Species (Alpha-code)") + 
#   # coord_flip() +
#   # gghighlight(SGCN %in% c("1", "2", "3")) +
#   # gghighlight(spp %in% c("BETH")) +
#   theme(
#     axis.text.y = element_blank()
#   )




plot.effects <- m.effects.sum %>%
ggplot(aes(x = median_effect_urb, y = median_effect_temp, 
           fill = median_effect_urb, color = median_effect_urb)) + #
  theme_classic() +
  # scale_color_viridis_c(option = "plasma", direction = -1) +
  scale_color_distiller(palette = "RdYlBu", direction = 1)+
  scale_fill_distiller(palette = "RdYlBu", direction = 1)+
  geom_vline(xintercept = 0, color = "black", linetype = "dashed") +
  geom_hline(yintercept = 0, color = "black", linetype = "dashed") +
  # geom_errorbar(aes(xmin = low90_effect_urb, xmax = upp90_effect_urb), alpha = 1) +
  # geom_errorbar(aes(ymin = low90_effect_temp, ymax = upp90_effect_temp), alpha = 1) +
  geom_errorbar(aes(xmin = median_effect_urb+0.5*median_effect_tempint, xmax = median_effect_urb), alpha = 1, color = "gray") +
  geom_point(pch = 21, color = "gray70") +
  labs(x = "Relationship with Urbanization (ENDISI)", y = "Relationship with Temperature (Daily Minimum)") + 
  # gghighlight(SGCN %in% c("1", "2", "3")) +
  # gghighlight(spp %in% c("ANHU")) +
  gghighlight(!common_name %in% c(spp.neutral)) +
  # gghighlight(spp %in% c(m.effects.sum %>% filter(upp90_effect_urb < 0) %>% pull(spp))) +
  theme(
    # axis.text.x = element_blank()
  )
plot.effects


# ggsave("~/Github/caplter-dynamicbirds/figures/effects_UrbanTemp_byUrban.png",
#        plot.effects,
#        width = 6,
#        height = 4.5,
#        units = "in",
#        dpi = 300)

```


```{r temp vs temp interaction}
plot.effects <- m.effects.sum %>%
ggplot(aes(x = median_effect_temp, y = median_effect_tempint, 
           fill = log(Mass), color = log(Mass))) + #
  theme_classic() +
  # scale_color_distiller(palette = "PuOr", direction = 1)+
  # scale_fill_distiller(palette = "PuOr", direction = 1)+
  scale_color_viridis_c(option = "plasma", direction = -1) +
  scale_fill_viridis_c(option = "plasma", direction = -1)+
  geom_vline(xintercept = 0, color = "black", linetype = "dashed") +
  geom_hline(yintercept = 0, color = "black", linetype = "dashed") +
  geom_errorbar(aes(xmin = low90_effect_temp, xmax = upp90_effect_temp), alpha = 0.6) +
  geom_errorbar(aes(ymin = low90_effect_tempint, ymax = upp90_effect_tempint), alpha = 0.6) +
  geom_point(pch = 21, color = "gray70", show.legend = FALSE) +
  labs(x = "Relationship with Temperature \n(Daily Minimum)", y = "Urbanization-Temperature Interaction", color = "Body Mass \nlog(Kg)") + 
  # gghighlight(SGCN %in% c("1", "2", "3")) +
  # gghighlight(spp %in% c("BETH")) +
  # gghighlight(common_name %in% c(spp.urb.negative, spp.urb.positive,
  #                        spp.temp.negative, spp.temp.positive,
  #                        spp.tempint.negative, spp.tempint.positive)) +
  # gghighlight(spp %in% c(m.effects.sum %>% filter(upp90_effect_urb < 0) %>% pull(spp))) +
  theme(
    # axis.text.x = element_blank()
  )
plot.effects
```

### Urbanization vs. Vegetation Effects
```{r}

plot.effects <- m.effects.sum %>%
ggplot(aes(x = median_effect_urb, y = median_effect_veg, 
           fill = median_effect_urb, color = median_effect_urb)) + #
  theme_classic() +
  # scale_x_discrete(labels = m.effects.sum$spp) +
  scale_color_distiller(palette = "RdYlBu", direction = 1)+
  scale_fill_distiller(palette = "RdYlBu", direction = 1)+
  geom_vline(xintercept = 0, color = "black", linetype = "dashed") +
  geom_hline(yintercept = 0, color = "black", linetype = "dashed") +
  geom_errorbar(aes(xmin = low90_effect_urb, xmax = upp90_effect_urb), alpha = 1) +
  geom_errorbar(aes(ymin = low90_effect_veg, ymax = upp90_effect_veg), alpha = 1) +
  geom_point(pch = 21, color = "gray70") +
  labs(x = "Relationship with Urbanization (ENDISI)", y = "Relationship with Vegetation (NDVI)") + 
  # gghighlight(SGCN %in% c("1", "2", "3")) +
  # gghighlight(spp %in% c("BETH")) +
  # gghighlight(common_name %in% c(#spp.urb.negative, spp.urb.positive,
  #                        spp.veg.negative, spp.veg.positive,
  #                        spp.vegint.negative, spp.vegint.positive)) +
  # gghighlight(spp %in% c(m.effects.sum %>% filter(upp90effect_urb < 0) %>% pull(spp))) +
  theme(
    # axis.text.x = element_blank()
  )
plot.effects

# ggsave("~/Github/caplter-dynamicbirds/figures/effects_UrbanNDVI_byUrban.png",
#        plot.effects,
#        width = 6,
#        height = 4.5,
#        units = "in",
#        dpi = 300)
```

### Trait Effects

```{r SUP FIGURE urbanization effects by size}
plot.effects <- m.effects.sum %>%
ggplot(aes(x = log10(Mass), y = median_effect_urb, color = log10(Mass), fill = log10(Mass))) +
  theme_classic() +
  geom_hline(yintercept = 0, color = "black", linetype = "dashed") +
  scale_x_continuous(trans = "log10",
         breaks = log10(c(1, 3, 5, 10, 25, 50, 100, 250, 500, 1000, 2500, 5000)),
         labels = c("1","3", "5", "10", "25","50","100","250", "500", "1000","2500","5000")) +
  # coord_cartesian(xlim = c(0.25, 4)) +
  # option A: plain colors
    geom_errorbar(aes(ymin = low90_effect_urb, ymax = upp90_effect_urb), color = "gray30",
                  alpha = 1, linewidth = 0.12, width = 0) +
    geom_point(pch = 23, size = 1.4, alpha = 1, fill = "gray30", color = "gray30", stroke = 0.1) + 
  # option B: points and bars colored by traits
    # geom_errorbar(aes(ymin = low90_effect_urb, ymax = upp90_effect_urb), color = "gray50",
    #               alpha = 1, linewidth = 0.12, width = 0) +
    # geom_errorbar(aes(ymin = low90_effect_urb, ymax = upp90_effect_urb),
    #               alpha = 1, linewidth = 0.1, width = 0) +
    # geom_point(pch = 23, size = 1.4, alpha = 1, color = "gray50", stroke = 0.1) +   #pch = 21, fill = NA
    # scale_color_viridis_c(option = "plasma", direction = -1, trans = "log10") +
    # scale_fill_viridis_c(option = "plasma", direction = -1, trans = "log10") +   
  labs(x = "Body Mass (g)", y = "Relationship with Urbanization (ENDISI)") + 
  # coord_flip() + 
  theme(
    legend.position = "none",
    # legend.position = "top",
    # legend.margin = margin(t = 5, r = 74, b = 5, l = 5, unit = "pt"),
    # axis.text.x = element_text(face = "bold", size = 7), 
    axis.text.y = element_text(face = "bold", size = 7),
    axis.text.x = element_text(face = "bold", size = 7, angle = -30, vjust = -0.3),
    axis.title.x = element_text(face = "bold", size = 9), 
    axis.title.y = element_text(face = "bold", size = 9)
    )
plot.effects

ggsave("~/Github/caplter-dynamicbirds/figures/effect_urb_size.png",
       plot.effects,
       width = 6,
       height = 3,
       units = "in",
       dpi = 300)
```
```{r SUP FIGURE temp effects by body size}

plot.effects <- m.effects.sum %>%
ggplot(aes(x = median_effect_temp, y = median_effect_tempint, 
           fill = log(Mass), color = log(Mass))) + #
  theme_classic() +
  scale_color_viridis_c(option = "plasma", direction = -1) +
  scale_fill_viridis_c(option = "plasma", direction = -1)+
  geom_vline(xintercept = 0, color = "black", linetype = "dashed") +
  geom_hline(yintercept = 0, color = "black", linetype = "dashed") +
  # geom_point(pch = 21, color = "gray30", show.legend = FALSE, size = 1, alpha = 1) +
  geom_errorbar(aes(xmin = low90_effect_temp, xmax = upp90_effect_temp), color = "gray50",
                alpha = 1, linewidth = 0.12) +
  geom_errorbar(aes(ymin = low90_effect_tempint, ymax = upp90_effect_tempint), color = "gray50",
                alpha = 1, linewidth = 0.12) +
  geom_errorbar(aes(xmin = low90_effect_temp, xmax = upp90_effect_temp), alpha = 1, linewidth = 0.1) +
  geom_errorbar(aes(ymin = low90_effect_tempint, ymax = upp90_effect_tempint), alpha = 1, linewidth = 0.1) +
  geom_point(pch = 23, , show.legend = FALSE, size = 1.4, alpha = 1, color = "gray50", stroke = 0.1) +
  labs(x = "Relationship with Temperature", y = "Urbanization-Temperature Interaction", color = "Body Mass \nlog(Kg)") + 
  coord_cartesian(xlim = c(-1,1), ylim=c(-1,1)) +
  gghighlight(!common_name %in% c(spp.neutral)) +
  theme(
    legend.position = "none",
    # legend.margin = margin(t = 5, r = 74, b = 5, l = 5, unit = "pt"),
    axis.text.x = element_text(face = "bold", size = 7), 
    axis.text.y = element_text(face = "bold", size = 7), 
    axis.title.x = element_text(face = "bold", size = 9), 
    axis.title.y = element_text(face = "bold", size = 9)
    )
plot.effects


ggsave("~/Github/caplter-dynamicbirds/figures/effects_TempbySize.png",
       plot.effects,
       width = 3,
       height = 3,
       units = "in",
       dpi = 300)
```

```{r SUP FIGURE veg effects by body size}

plot.effects <- m.effects.sum %>%
ggplot(aes(x = median_effect_veg, y = median_effect_vegint, 
           fill = log(Mass), color = log(Mass))) + #
  theme_classic() +
  scale_color_viridis_c(option = "plasma", direction = -1) +
  scale_fill_viridis_c(option = "plasma", direction = -1)+
  geom_vline(xintercept = 0, color = "black", linetype = "dashed") +
  geom_hline(yintercept = 0, color = "black", linetype = "dashed") +
  # geom_point(pch = 21, color = "gray30", show.legend = FALSE, size = 1, alpha = 1) +
  geom_errorbar(aes(xmin = low90_effect_veg, xmax = upp90_effect_veg), color = "gray50", 
                alpha = 1, linewidth = 0.12) +
  geom_errorbar(aes(ymin = low90_effect_vegint, ymax = upp90_effect_vegint), color = "gray50", 
                alpha = 1, linewidth = 0.12) +
  geom_errorbar(aes(xmin = low90_effect_veg, xmax = upp90_effect_veg), alpha = 1, linewidth = 0.1) +
  geom_errorbar(aes(ymin = low90_effect_vegint, ymax = upp90_effect_vegint), alpha = 1, linewidth = 0.1) +
  geom_point(pch = 23, , show.legend = FALSE, size = 1.4, alpha = 0.8, color = "gray50", stroke = 0.1) +
  labs(x = "Relationship with Vegetation", y = "Urbanization-Vegetation Interaction", color = "Body Mass \nlog(Kg)") + 
  coord_cartesian(xlim = c(-1,1), ylim=c(-1,1)) +
  gghighlight(!common_name %in% c(spp.neutral)) +
  # gghighlight(common_name %in% c(spp.temp.negative, spp.temp.positive, 
  #                                spp.tempint.negative, spp.tempint.positive)) +
  theme(
    legend.position = "none",
    # legend.margin = margin(t = 5, r = 74, b = 5, l = 5, unit = "pt"),
    axis.text.x = element_text(face = "bold", size = 7), 
    axis.text.y = element_text(face = "bold", size = 7), 
    axis.title.x = element_text(face = "bold", size = 9), 
    axis.title.y = element_text(face = "bold", size = 9)
    )
plot.effects


ggsave("~/Github/caplter-dynamicbirds/figures/effects_VegbySize.png",
       plot.effects,
       width = 3,
       height = 3,
       units = "in",
       dpi = 300)
```
```{r SUP FIGURE temp effects by diet}

plot.effects <- m.effects.sum %>%
ggplot(aes(x = median_effect_temp, y = median_effect_tempint, 
           fill = dietdiv, color = dietdiv)) + #
  theme_classic() +
  scale_color_viridis_c(option = "viridis", direction = -1) +
  scale_fill_viridis_c(option = "viridis", direction = -1)+
  geom_vline(xintercept = 0, color = "black", linetype = "dashed") +
  geom_hline(yintercept = 0, color = "black", linetype = "dashed") +
  # geom_point(pch = 21, color = "gray30", show.legend = FALSE, size = 1, alpha = 1) +
  geom_errorbar(aes(xmin = low90_effect_temp, xmax = upp90_effect_temp), color = "gray50",
                alpha = 1, linewidth = 0.12) +
  geom_errorbar(aes(ymin = low90_effect_tempint, ymax = upp90_effect_tempint), color = "gray50",
                alpha = 1, linewidth = 0.12) +
  geom_errorbar(aes(xmin = low90_effect_temp, xmax = upp90_effect_temp), alpha = 1, linewidth = 0.1) +
  geom_errorbar(aes(ymin = low90_effect_tempint, ymax = upp90_effect_tempint), alpha = 1, linewidth = 0.1) +
  geom_point(pch = 23, , show.legend = FALSE, size = 1.4, alpha = 0.8, color = "gray50", stroke = 0.1) +
  labs(x = "Relationship with Temperature", y = "Urbanization-Temperature Interaction", color = "Diet Diversity Index") + 
  coord_cartesian(xlim = c(-1,1), ylim=c(-1,1)) +
  gghighlight(!common_name %in% c(spp.neutral)) +
  theme(
    legend.position = "none",
    # legend.margin = margin(t = 5, r = 74, b = 5, l = 5, unit = "pt"),
    axis.text.x = element_text(face = "bold", size = 7), 
    axis.text.y = element_text(face = "bold", size = 7), 
    axis.title.x = element_text(face = "bold", size = 9), 
    axis.title.y = element_text(face = "bold", size = 9)
    )
plot.effects


ggsave("~/Github/caplter-dynamicbirds/figures/effects_TempbyDiet.png",
       plot.effects,
       width = 3,
       height = 3,
       units = "in",
       dpi = 300)
```

```{r SUP FIGURE veg effects by body size}

plot.effects <- m.effects.sum %>%
ggplot(aes(x = median_effect_veg, y = median_effect_vegint, 
           fill = log(Mass), color = log(Mass))) + #
  theme_classic() +
  scale_color_viridis_c(option = "plasma", direction = -1) +
  scale_fill_viridis_c(option = "plasma", direction = -1)+
  geom_vline(xintercept = 0, color = "black", linetype = "dashed") +
  geom_hline(yintercept = 0, color = "black", linetype = "dashed") +
  # geom_point(pch = 21, color = "gray30", show.legend = FALSE, size = 1, alpha = 1) +
  geom_errorbar(aes(xmin = low90_effect_veg, xmax = upp90_effect_veg), color = "gray50", 
                alpha = 1, linewidth = 0.12) +
  geom_errorbar(aes(ymin = low90_effect_vegint, ymax = upp90_effect_vegint), color = "gray50", 
                alpha = 1, linewidth = 0.12) +
  geom_errorbar(aes(xmin = low90_effect_veg, xmax = upp90_effect_veg), alpha = 1, linewidth = 0.1) +
  geom_errorbar(aes(ymin = low90_effect_vegint, ymax = upp90_effect_vegint), alpha = 1, linewidth = 0.1) +
  geom_point(pch = 23, , show.legend = FALSE, size = 1.4, alpha = 0.8, color = "gray50", stroke = 0.1) +
  labs(x = "Relationship with Vegetation", y = "Urbanization-Vegetation Interaction", color = "Diet Diversity Index") + 
  coord_cartesian(xlim = c(-1,1), ylim=c(-1,1)) +
  gghighlight(!common_name %in% c(spp.neutral)) +
  theme(
    legend.position = "none",
    # legend.margin = margin(t = 5, r = 74, b = 5, l = 5, unit = "pt"),
    axis.text.x = element_text(face = "bold", size = 7), 
    axis.text.y = element_text(face = "bold", size = 7), 
    axis.title.x = element_text(face = "bold", size = 9), 
    axis.title.y = element_text(face = "bold", size = 9)
    )
plot.effects


ggsave("~/Github/caplter-dynamicbirds/figures/effects_VegbyDiet.png",
       plot.effects,
       width = 3,
       height = 3,
       units = "in",
       dpi = 300)
```

```{r urb vs veg effect by body size}

plot.effects <- m.effects.sum %>%
ggplot(aes(x = median_effect_urb, y = median_effect_veg, 
           fill = log(Mass), color = log(Mass))) + #
  theme_classic() +
  # scale_color_distiller(palette = "PuOr", direction = 1)+
  # scale_fill_distiller(palette = "PuOr", direction = 1)+
  scale_color_viridis_c(option = "plasma", direction = -1) +
  scale_fill_viridis_c(option = "plasma", direction = -1)+
  geom_vline(xintercept = 0, color = "black", linetype = "dashed") +
  geom_hline(yintercept = 0, color = "black", linetype = "dashed") +
  geom_errorbar(aes(xmin = low90_effect_urb, xmax = upp90_effect_urb), alpha = 0.8) +
  geom_errorbar(aes(ymin = low90_effect_veg, ymax = upp90_effect_veg), alpha = 0.8) +
  geom_point(pch = 21, color = "gray70", show.legend = FALSE, alpha = 0.8) +
  labs(x = "Relationship with Urbanization (ENDISI)", y = "Relationship with Vegetation (NDVI)", color = "Body Mass \nlog(Kg)") + 
  coord_cartesian(xlim = c(-2.25,2.25), ylim=c(-1.75,1.75)) +
  theme(
    axis.text.x = element_text(face = "bold", size = 7), 
    axis.text.y = element_text(face = "bold", size = 7), 
    axis.title.x = element_text(face = "bold", size = 9), 
    axis.title.y = element_text(face = "bold", size = 9),
    legend.position = "none",
    legend.margin = margin(t = 5, r = 74, b = 5, l = 5, unit = "pt")
    )
plot.effects


ggsave("~/Github/caplter-dynamicbirds/figures/effects_UrbanVeg_bySize.png",
       plot.effects,
       width = 3,
       height = 3,
       units = "in",
       dpi = 300)
```



```{r urb vs temp effects by size}

plot.effects <- m.effects.sum %>%
ggplot(aes(x = median_effect_urb, y = median_effect_temp, 
           fill = log(Mass), color = log(Mass))) + #
  theme_classic() +
  # 
  # scale_color_distiller(palette = "PuOr", direction = 1)+
  # scale_fill_distiller(palette = "PuOr", direction = 1)+
  scale_color_viridis_c(option = "plasma", direction = -1) +
  scale_fill_viridis_c(option = "plasma", direction = -1)+
  geom_vline(xintercept = 0, color = "black", linetype = "dashed") +
  geom_hline(yintercept = 0, color = "black", linetype = "dashed") +
  geom_errorbar(aes(xmin = low90_effect_urb, xmax = upp90_effect_urb), alpha = 0.6) +
  geom_errorbar(aes(ymin = low90_effect_temp, ymax = upp90_effect_temp), alpha = 0.6) +
  geom_point(pch = 21, color = "gray70", show.legend = FALSE) +
  labs(x = "Relationship with Urbanization (ENDISI)", y = "Relationship with Temperature \n(Daily Minimum)", color = "Body Mass \nlog(Kg)") + 
  # gghighlight(SGCN %in% c("1", "2", "3")) +
  # gghighlight(spp %in% c("BETH")) +
  # gghighlight(common_name %in% c(#spp.urb.negative, spp.urb.positive,
  #                        spp.temp.negative, spp.temp.positive,
  #                        spp.tempint.negative, spp.tempint.positive)) +
  # gghighlight(spp %in% c(m.effects.sum %>% filter(upp90_effect_urb < 0) %>% pull(spp))) +
  theme(
    # axis.text.x = element_blank()
  )
plot.effects


ggsave("~/Github/caplter-dynamicbirds/figures/effects_UrbanTemp_bySize.png",
       plot.effects,
       width = 7,
       height = 6,
       units = "in",
       dpi = 300)
```

```{r urb vs temp interaction by size}


m.effects.sum %>%
ggplot(aes(x = median_effect_urb, y = median_effect_tempint, 
           fill = median_effect_urb, color = median_effect_urb)) + #
  theme_classic() +
  # scale_color_distiller(palette = "RdYlBu", direction = 1)+
  # scale_fill_distiller(palette = "RdYlBu", direction = 1)+
  scale_color_viridis_c(option = "plasma", direction = -1) +
  scale_fill_viridis_c(option = "plasma", direction = -1)+
  geom_vline(xintercept = 0, color = "black", linetype = "dashed") +
  geom_hline(yintercept = 0, color = "black", linetype = "dashed") +
  geom_errorbar(aes(xmin = low90_effect_urb, xmax = upp90_effect_urb), alpha = 0.6) +
  geom_errorbar(aes(ymin = low90_effect_tempint, ymax = upp90_effect_tempint), alpha = 0.6) +
  geom_point(pch = 21, color = "gray70") +
  labs(x = "Relationship with Urbanization (ENDISI)", y = "Temperature Interaction with Urbanization") + 
  # gghighlight(SGCN %in% c("1", "2", "3")) +
  # gghighlight(spp %in% c("BETH")) +
  gghighlight(common_name %in% c(#spp.urb.negative, spp.urb.positive,
                         spp.temp.negative, spp.temp.positive,
                         spp.tempint.negative, spp.tempint.positive)) +
  # gghighlight(spp %in% c(m.effects.sum %>% filter(upp90_effect_urb < 0) %>% pull(spp))) +
  theme(
    # axis.text.x = element_blank()
  )

plot.effects <- m.effects.sum %>%
ggplot(aes(x = median_effect_urb, y = median_effect_tempint, 
           fill = log(Mass), color = log(Mass))) + #
  theme_classic() +
  # scale_color_distiller(palette = "PuOr", direction = 1)+
  # scale_fill_distiller(palette = "PuOr", direction = 1)+
  scale_color_viridis_c(option = "plasma", direction = -1) +
  scale_fill_viridis_c(option = "plasma", direction = -1)+
  geom_vline(xintercept = 0, color = "black", linetype = "dashed") +
  geom_hline(yintercept = 0, color = "black", linetype = "dashed") +
  geom_errorbar(aes(xmin = low90_effect_urb, xmax = upp90_effect_urb), alpha = 1) +
  geom_errorbar(aes(ymin = low90_effect_tempint, ymax = upp90_effect_tempint), alpha = 1) +
  geom_point(pch = 21, color = "gray70", show.legend = FALSE) +
  labs(x = "Relationship with Urbanization (ENDISI)", y = "Temperature Interaction with Urbanization", color = "Body Mass \nlog(Kg)") + 
  # gghighlight(SGCN %in% c("1", "2", "3")) +
  # gghighlight(spp %in% c("BETH")) +
  # gghighlight(common_name %in% c(
  #                        # spp.urb.negative, spp.urb.positive,
  #                        # spp.temp.negative, spp.temp.positive,
  #                        spp.tempint.negative, spp.tempint.positive)) +
  # gghighlight(spp %in% c(m.effects.sum %>% filter(upp90_effect_urb < 0) %>% pull(spp))) +
  theme(
    # axis.text.x = element_blank()
  )
plot.effects


ggsave("~/Github/caplter-dynamicbirds/figures/effects_UrbanTempInt_bySize.png",
       plot.effects,
       width = 7,
       height = 6,
       units = "in",
       dpi = 300)
```



### Effects by SGCN

```{r urbanization effects by SGCN}

m.effects.sum %>%
ggplot(aes(x = as.factor(order_urbeffect), y = median_effect_urb, color = as.factor(SGCN))) +
  theme_classic() +
  scale_x_discrete(labels = m.effects.sum$spp) +
  geom_hline(yintercept = 0, color = "black", linetype = "dashed") +
  geom_pointrange(aes(ymin = low90_effect_urb, ymax = upp90_effect_urb)) +
  labs(x = "Species", y = "Relationship with Urbanization (ENDISI)", color = "SGCN \nTier") + 
  gghighlight(SGCN %in% c("1", "2", "3")) +
  # gghighlight(spp %in% c("BETH")) +
  # gghighlight(spp %in% c(m.effects.sum %>% filter(low90_effect_urb > 0) %>% pull(spp))) +
  # gghighlight(spp %in% c(m.effects.sum %>% filter(upp90_effect_urb < 0) %>% pull(spp))) +
  theme(
    axis.text.x = element_blank()
  )

# Depicting the whole posterior
# m.effects %>%
# ggplot(aes(x = effect_urb, group = spp, fill = as.factor(SGCN))) +
#   theme_classic() +
#   geom_vline(xintercept = 0, color = "red", linetype = "dashed") +
#   geom_density(alpha = 0.3, color = "transparent", color = "gray10") +
#   scale_y_discrete(labels = m.effects.sum$spp) +
#   #geom_pointrange(aes(x = median, xmin = low95, xmax = upp95)) +
#   labs(x = "Relationship with Urbanization (ENDISI)", y = "Density") + 
#   # coord_flip() +
#   # gghighlight(SGCN %in% c("1", "2", "3")) +
#   gghighlight(low90_effect_urb > 0) +
#   theme()

plot.effects <- m.effects.sum %>%
ggplot(aes(x = as.factor(order_urbeffect), y = median_effect_urb, color = as.factor(SGCN))) +
  theme_classic() +
  geom_hline(yintercept = 0, color = "black", linetype = "dashed") +
  geom_linerange(aes(ymin = low90_effect_urb, ymax = upp90_effect_urb), 
                 width = 0.4, size = 0.4, alpha = 1)+
  geom_point(pch = 16, size = 1) +   #pch = 21, fill = NA
  # geom_pointrange(aes(ymin = low90_effect_urb, ymax = upp90_effect_urb)) +
  # scale_color_manual(values = brewer.pal(8,"Set2")[c(2,6,1)]) +
  scale_x_discrete(labels = m.effects.sum$spp) +
  labs(x = "Species", y = "Relationship with Urbanization (ENDISI)", color = "SGCN \nTier") + 
  gghighlight(SGCN %in% c("1", "2", "3")) +
  # gghighlight(spp %in% c(#"GAQU", "CACW", "ANHU", "COHU", "GTGR"
  #                        "BBWD")) +
  # gghighlight(spp %in% c(m.effects.sum %>% filter(low90_effect_urb > 0) %>% pull(spp))) +
  coord_flip() +
  theme(
    # legend.position = "none",
    legend.position = "top",
    # axis.text.x = element_text(angle = 30, vjust = 1, hjust=1, size = 14),
    axis.text.y = element_blank(),
    axis.text.x = element_text(size = 14),
    axis.title = element_text(face = "bold", size = 16),
    legend.title = element_text(face = "bold", size = 16),
    legend.text = element_text(size = 14)
  ) 
plot.effects

ggsave("~/Github/caplter-dynamicbirds/figures/effect_urb_SGCN.png",
       plot.effects,
       width = 7,
       height = 4,
       units = "in",
       dpi = 300)

```


```{r temperature and vegetation effects by SGCN}

m.effects.sum %>% #filter(SGCN %in% c("1", "2", "3")) %>%
ggplot(aes(x = as.factor(order_tempeffect), y = median_effect_temp, color = as.factor(SGCN))) +
  theme_classic() +
  scale_x_discrete(labels = m.effects.sum$spp) +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  geom_pointrange(aes(ymin = low90_effect_temp, ymax = upp90_effect_temp)) +
  labs(x = "Species (Alpha-code)", y = "Effect of Temperature (Daily Minimum)", color = "SGCN \nTier") + 
  # gghighlight(SGCN %in% c("1", "2", "3")) +
  # gghighlight(spp %in% c("BETH")) +
  # gghighlight(spp %in% c(m.effects.sum %>% filter(low90_effect_temp > 0) %>% pull(spp))) +
  theme(
    axis.text.x = element_blank()
  )


m.effects.sum %>% #filter(SGCN %in% c("1", "2", "3")) %>%
ggplot(aes(x = as.factor(order_vegeffect), y = median_effect_veg, color = as.factor(SGCN))) +
  theme_classic() +
  scale_x_discrete(labels = m.effects.sum$spp) +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  geom_pointrange(aes(ymin = low90_effect_veg, ymax = upp90_effect_veg)) +
  labs(x = "Species (Alpha-code)", y = "Effect of Vegetation (NDVI)", color = "SGCN \nTier") + 
  # gghighlight(SGCN %in% c("1", "2", "3")) +
  # gghighlight(spp %in% c("BETH")) +
  # gghighlight(spp %in% c(m.effects.sum %>% filter(low90_effect_veg > 0) %>% pull(spp))) +
  theme(
    axis.text.x = element_blank()
  )
```

```{r urb vs temp effects by SGCN}
m.effects.sum %>%
ggplot(aes(x = median_effect_urb, y = median_effect_temp, color = as.factor(SGCN))) + #
  theme_classic() +
  # scale_x_discrete(labels = m.effects.sum$spp) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed") +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  geom_point() +
  geom_errorbar(aes(xmin = low90_effect_urb, xmax = upp90_effect_urb), alpha = 0.2) +
  geom_errorbar(aes(ymin = low90_effect_temp, ymax = upp90_effect_temp), alpha = 0.2) +
  labs(x = "Relationship with Urbanization (ENDISI)", y = "Relationship with Temperature (Daily Minimum)") + 
  # gghighlight(SGCN %in% c("1", "2", "3")) +
  # gghighlight(spp %in% c("BETH")) +
  gghighlight(common_name %in% c(spp.urb.negative, spp.urb.positive,
                         spp.temp.negative, spp.temp.positive,
                         spp.tempint.negative, spp.tempint.positive)) +
  # gghighlight(spp %in% c(m.effects.sum %>% filter(upp90_effect_urb < 0) %>% pull(spp))) +
  theme(
    # axis.text.x = element_blank()
  )
```
```{r urb vs veg effects by SGCN and urb}
# m.effects %>% filter(SGCN %in% c("1", "2", "3")) %>%
# ggplot(aes(x = effect_urb, y = order_urbeffect, group = order_urbeffect, fill = as.factor(SGCN))) +
#   theme_classic() +
#   geom_vline(xintercept = 0, color = "red", linetype = "dashed") +
#   geom_density_ridges(alpha = 0.5, color = "transparent") +
#   scale_y_discrete(labels = m.effects.sum$spp) +
#   geom_pointrange(aes(x = median_effect_veg, xmin = low90_effect_veg, xmax = upp90_effect_veg)) +
#   labs(x = "Covariate Effect", y = "Species (Alpha-code)") + 
#   # coord_flip() +
#   # gghighlight(SGCN %in% c("1", "2", "3")) +
#   # gghighlight(spp %in% c("BETH")) +
#   theme(
#     axis.text.y = element_blank()
#   )


m.effects.sum %>%
ggplot(aes(x = median_effect_urb, y = median_effect_veg, color = as.factor(SGCN))) + #
  theme_classic() +
  # scale_x_discrete(labels = m.effects.sum$spp) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed") +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  geom_point() +
  geom_errorbar(aes(xmin = low90_effect_urb, xmax = upp90_effect_urb), alpha = 0.2) +
  geom_errorbar(aes(ymin = low90_effect_veg, ymax = upp90_effect_veg), alpha = 0.2) +
  labs(x = "Relationship with Urbanization (ENDISI)", y = "Relationship with Vegetation (NDVI)") + 
  # gghighlight(SGCN %in% c("1", "2", "3")) +
  # gghighlight(spp %in% c("BETH")) +
  gghighlight(common_name %in% c(spp.urb.negative, spp.urb.positive,
                         spp.veg.negative, spp.veg.positive,
                         spp.vegint.negative, spp.vegint.positive)) +
  # gghighlight(spp %in% c(m.effects.sum %>% filter(upp90_effect_urb < 0) %>% pull(spp))) +
  theme(
    # axis.text.x = element_blank()
  )


```




# Plot Predicted Values
```{r prep for urbanization gradient predictions}
# for illustrative purposes, one might want to use a smaller number of posterior samples
set.seed(54321)
nsamp <- nrow(tmp[[1]])/4     
samp <- sample(1:nrow(tmp[[1]]), size = nsamp, replace = FALSE)
# samp <- 1:nrow(tmp[[1]])

# To more effectively highlight the statistical effects modeled in the model, we will predict effects across a range of hypothetical local urbanization values, under contrasting ranges of temperature/vegetation.
# For each interacting variable, we will hold any other variable(s) constant at their mean (zero)
npred <- 200    

urban.pred <- seq(min(env.model$ENDISIadj_std), max(env.model$ENDISIadj_std), length.out = npred)
 
  
# What are some good values of temperature and vegetation to predict at?
    # Let's start by looking at the across-site means for each year
    env.spr %>% pull(temp_min) %>% range() # about a 5 degree range of values
    env.spr %>% pull(temp_min) %>% mean()  # ~16 degrees is the mean across all sites and years
    env.spr %>% pull(temp_min) %>% sd()
    env.spr %>% reframe(mean = mean(temp_min), sd = sd(temp_min), 
                        min = min(temp_min), max = max(temp_min),
                        .by = c(survey_year)) %>% 
      arrange(mean) # mean and sd among sites across years
    # the warmest site in the coldest year was close to the same temp. as the coldest site in the warmest year
    # i.e., more variation among sites then there is among years
    # BUT, it's pretty close, about a 2-3 degree difference among sites and years
  
    # For illustrative purposes, we could use values close to the range of temperatures,
    # The hottest spring-average daily minimum temperature across all years was 18.068 (in 2022)
    # The coldest spring was still 12.767 (in 2010)
    # 13 to 18 C = 55.4 to 64.4 F -> it would be realistic to do 55 to 65 F
    
    env.spr %>% pull(NDVI) %>% range() # huge range in NDVI
    env.spr %>% pull(NDVI) %>% mean()  # 0.185 is the mean across all sites and years
    env.spr %>% pull(NDVI) %>% sd()
    env.spr %>% reframe(mean = mean(NDVI), sd = sd(NDVI),
                        min = min(NDVI), max = max(NDVI), diff = (max(NDVI)-min(NDVI)),
                        .by = c(site_code)) %>% arrange(diff)
    # Across years, the least green sites has a range of ~0.021, the greenest a range of ~0.232
    # In the least green year, sites ranged in value by ~0.364, in the greenest year about the same (0.380)
    # The difference b/w the least green and greenest site varied between 0.281 to 0.509
    # what about quantiles?
    env.spr %>% pull(NDVI) %>% quantile(probs = c(0.1, 0.9))
    # the 10th and 90th percentile values seem like reasonable cutoffs
```
### Community-level urbanization effects, in real occupancy terms
For instance, what is the predicte difference in occupancy between the least and most urbanized site?
```{r urbanization only predictions}
# str(urban.pred)

# objects for storing prediction summary stats
    nline <- 1
    preds.psi.mean <- rep(NA, npred*nline)
    preds.psi.med <- rep(NA, npred*nline)
    preds.psi.lowCI <- rep(NA, npred*nline)
    preds.psi.uppCI <- rep(NA, npred*nline)   
    
        mcmc.beta <- tmp$beta.comm[samp,]
        # predict across the urbanization gradient, with everything else held constant
      for(r in 1:nline){
        # a design matrix 
        dm.urb <- cbind(
          1,
          urban.pred,  # urbanization
          0, #pred.TEMP[r],  # Temperature
          0, #pred.TEMP[r]*urban.pred,  # MAT*urbanization
          0, # pred.VEG[r],  # NDVI
          0# pred.VEG[r]*urban.pred  # NDVI*urbanization
        )
        
        # mcmc.beta <- tmp$beta.comm
        
        preds.psi <- plogis(mcmc.beta %*% t(dm.urb))  # predict
        
        preds.psi.cri <- apply(preds.psi, 2, quantile, probs = c(0.05,0.5,0.95)) %>% t() %>% data.frame()
        
        preds.psi.mean[(r*npred-npred+1):(r*npred)] <- apply(preds.psi, c(2), function(x)   mean(x, na.rm=TRUE))    # posterior mean
        preds.psi.lowCI[(r*npred-npred+1):(r*npred)] <- preds.psi.cri[,1]
        preds.psi.med[(r*npred-npred+1):(r*npred)] <- preds.psi.cri[,2]
        preds.psi.uppCI[(r*npred-npred+1):(r*npred)] <- preds.psi.cri[,3]
        
        
      }
  
        
        data.pred.URB <- data.frame(
        "impervious" = rep(seq(min(env.model$ENDISIadj), 
                               max(env.model$ENDISIadj), length.out = npred), 1), # 1 instead of nline
        "impervious_std" = rep(urban.pred, 1), # 1 instead of nline
        # "level" = rep(c("low", "high"), each = npred),
        #"LST" = rep(env.model$LST, each = npred),
        # "LST" = rep((pred.TEMP*sd(env.model$LST)+mean(env.model$LST)), each = npred),
        # "temp_min" = rep((pred.TEMP*sd(env.model$temp_min)+mean(env.model$temp_min)), each = npred),
        "psi_med" = preds.psi.med,
        "psi_lowCI" = preds.psi.lowCI,
        "psi_uppCI" = preds.psi.uppCI
      )    
        
        data.pred.URB$impervious[1]
        
        # how much lower is occupancy at the most urbanized vs. least urbanized site
        data.pred.URB$psi_med[1]
        data.pred.URB$psi_med[nrow(data.pred.URB)]
        data.pred.URB$psi_med[1]/data.pred.URB$psi_med[nrow(data.pred.URB)]  # 4.9x lower (~1/5)
        
        (data.pred.URB$psi_med[1]-data.pred.URB$psi_med[nrow(data.pred.URB)])/data.pred.URB$psi_med[1]*100
        # an 80% reduction in occupancy across the gradient
        
        
```
```{r}
env.model %>% pull(temp_min) %>% mean()  # mean minimum temperature
env.model %>% pull(temp_min) %>% sd()    # 1 sd in variation

# how many temperature levels to predict across
pred.TEMP <- c(
            (15.90144-mean(spr$temp_min))/sd(env.model$temp_min), # 12.77778 C = 55 F
            (18.3333-mean(env.model$temp_min))/sd(env.model$temp_min)  # 18.3333 C = 65 F)
)
                # roughly the range of temperatures from 2000-2022

# objects for storing prediction summary stats
    nline <- length(pred.TEMP)
    preds.psi.mean <- rep(NA, npred*nline)
    preds.psi.med <- rep(NA, npred*nline)
    preds.psi.lowCI <- rep(NA, npred*nline)
    preds.psi.uppCI <- rep(NA, npred*nline)   

        mcmc.beta <- tmp$beta.comm[samp,]
        # predict across NDVI gradient
      for(r in 1:nline){ 
        # a design matrix 
        dm.urb <- cbind(
          1,
          urban.pred,  # urbanization
          pred.TEMP[r], #pred.TEMP[r],  # Temperature
          pred.TEMP[r]*urban.pred, #pred.TEMP[r]*urban.pred,  # MAT*urbanization
          0, # pred.VEG[r],  # NDVI
          0# pred.VEG[r]*urban.pred  # NDVI*urbanization
        )
        
        # mcmc.beta <- tmp$beta.comm
        
        preds.psi <- plogis(mcmc.beta %*% t(dm.urb))  # predict
        
        preds.psi.cri <- apply(preds.psi, 2, quantile, probs = c(0.05,0.5,0.95)) %>% t() %>% data.frame()
        
        preds.psi.mean[(r*npred-npred+1):(r*npred)] <- apply(preds.psi, c(2), function(x)   mean(x, na.rm=TRUE))    # posterior mean
        preds.psi.lowCI[(r*npred-npred+1):(r*npred)] <- preds.psi.cri[,1]
        preds.psi.med[(r*npred-npred+1):(r*npred)] <- preds.psi.cri[,2]
        preds.psi.uppCI[(r*npred-npred+1):(r*npred)] <- preds.psi.cri[,3]
        
        
      }
          
          
      data.pred.TEMP <- data.frame(
        "impervious" = rep(seq(min(env.model$ENDISIadj), max(env.model$ENDISIadj), length.out = npred), nline),
        "impervious_std" = rep(urban.pred, nline),
        "level" = rep(c("","low", "high", ""), each = npred),
        #"LST" = rep(env.model$LST, each = npred),
        # "LST" = rep((pred.TEMP*sd(env.model$LST)+mean(env.model$LST)), each = npred),
        "temp_min" = rep((pred.TEMP*sd(env.model$temp_min)+mean(env.model$temp_min)), each = npred),
        "psi_med" = preds.psi.med,
        "psi_lowCI" = preds.psi.lowCI,
        "psi_uppCI" = preds.psi.uppCI
      )    
      
      
       plot.tempint <- data.pred.TEMP %>% 
         ggplot(aes(x = impervious, y = psi_med, group = level)) +
        theme_classic() + 
         geom_smooth(aes(x = impervious, y = psi_med, group = level, color = temp_min, linetype = as.factor(temp_min)),
                     method = "gam", se = FALSE)+
        geom_ribbon(aes(x = impervious, y = psi_med, group = level, ymin = psi_lowCI, ymax = psi_uppCI, fill = temp_min), 
                    alpha = 0.4) + 
        scale_fill_distiller(palette = "RdYlBu", direction = -1)+
        scale_color_distiller(palette = "RdYlBu", direction = -1)+
        # scale_y_continuous(labels = label_number(accuracy = 0.1)) +
        scale_linetype_manual(values = c(2, 1)) +
        coord_cartesian(ylim=c(0,0.05))+
        labs(x = "Urbanization \n(ENDISI)", y = "Occupancy", title = "") + #, title = "Community-average"
        theme(axis.text.x = element_text(face = "bold", size = 7), 
              axis.text.y = element_text(face = "bold", size = 7), 
              axis.title.x = element_text(face = "bold", size = 9), 
              axis.title.y = element_text(face = "bold", size = 9),
              legend.position = "none",
              legend.margin = margin(t = 5, r = 74, b = 5, l = 5, unit = "pt") ) 
      print(plot.tempint)
```


```{r urb predictions at two temperatures - community}
sd(env.spr$temp_min) # roughly 1 degree
mean(env.spr$temp_min)+1

# how many temperature levels to predict across
pred.TEMP <- c(
  (12.77778-mean(env.spr$temp_min))/sd(env.spr$temp_min), # 12.77778 C = 55 
  (14.90144-mean(env.spr$temp_min))/sd(env.spr$temp_min), # minus 1C
  (mean(env.spr$temp_min)-mean(env.spr$temp_min))/sd(env.spr$temp_min), # minus 1C
  (16.90144-mean(env.spr$temp_min))/sd(env.spr$temp_min), # plus 1C
  (18.3333-mean(env.spr$temp_min))/sd(env.spr$temp_min)  # 18.3333 C = 65 F
                )
                # roughly the range of temperatures from 2000-2022

# objects for storing prediction summary stats
    nline <- length(pred.TEMP)
    preds.psi.mean <- rep(NA, npred*nline)
    preds.psi.med <- rep(NA, npred*nline)
    preds.psi.lowCI <- rep(NA, npred*nline)
    preds.psi.uppCI <- rep(NA, npred*nline)   

        mcmc.beta <- tmp$beta.comm[samp,]
        # predict across NDVI gradient
      for(r in 1:nline){ 
        # a design matrix 
        dm.urb <- cbind(
          1,
          urban.pred,  # urbanization
          pred.TEMP[r], #pred.TEMP[r],  # Temperature
          pred.TEMP[r]*urban.pred, #pred.TEMP[r]*urban.pred,  # MAT*urbanization
          0, # pred.VEG[r],  # NDVI
          0# pred.VEG[r]*urban.pred  # NDVI*urbanization
        )
        
        # mcmc.beta <- tmp$beta.comm
        
        preds.psi <- plogis(mcmc.beta %*% t(dm.urb))  # predict
        
        preds.psi.cri <- apply(preds.psi, 2, quantile, probs = c(0.05,0.5,0.95)) %>% t() %>% data.frame()
        
        preds.psi.mean[(r*npred-npred+1):(r*npred)] <- apply(preds.psi, c(2), function(x)   mean(x, na.rm=TRUE))    # posterior mean
        preds.psi.lowCI[(r*npred-npred+1):(r*npred)] <- preds.psi.cri[,1]
        preds.psi.med[(r*npred-npred+1):(r*npred)] <- preds.psi.cri[,2]
        preds.psi.uppCI[(r*npred-npred+1):(r*npred)] <- preds.psi.cri[,3]
        
        
      }
          
          
      data.pred.TEMP.comm <- data.frame(
        "impervious" = rep(seq(min(env.model$ENDISIadj), max(env.model$ENDISIadj), length.out = npred), nline),
        "impervious_std" = rep(urban.pred, nline),
        "level" = rep(c("low", "minus1C", "mean",  "plus1C", "high"), each = npred),
        #"LST" = rep(env.model$LST, each = npred),
        # "LST" = rep((pred.TEMP*sd(env.model$LST)+mean(env.model$LST)), each = npred),
        "temp_min" = rep((pred.TEMP*sd(env.model$temp_min)+mean(env.model$temp_min)), each = npred),
        "psi_med" = preds.psi.med,
        "psi_lowCI" = preds.psi.lowCI,
        "psi_uppCI" = preds.psi.uppCI
      )    
      
      # data.pred.TEMP.comm %>% filter(level %in% c("mean", "plus1C"))
      # 0.028208432 mean temp, low urb
      # 0.048436092 +1C temp, low urb
      # 0.005744220 mean temp, high urb
      # 0.003345943 +1C temp, high urb
      
      (0.048436092-0.028208432)/0.028208432*100
      (0.003345943-0.005744220)/0.005744220*100
      
       plot.tempint <- data.pred.TEMP.comm %>% 
         # filter(level %in% c("low", "high")) %>%
         filter(level %in% c("minus1C", "plus1C")) %>%
         ggplot(aes(x = impervious, y = psi_med, group = level)) +
        theme_classic() + 
         geom_smooth(aes(x = impervious, y = psi_med, group = level, color = temp_min, linetype = as.factor(temp_min)),
                     method = "gam", se = FALSE)+
        geom_ribbon(aes(x = impervious, y = psi_med, group = level, ymin = psi_lowCI, ymax = psi_uppCI, fill = temp_min), 
                    alpha = 0.4) + 
        scale_fill_distiller(palette = "RdYlBu", direction = -1)+
        scale_color_distiller(palette = "RdYlBu", direction = -1)+
        # scale_y_continuous(labels = label_number(accuracy = 0.1)) +
        scale_linetype_manual(values = c(2, 1)) +
        # coord_cartesian(ylim=c(0,0.05))+
        labs(x = "Urbanization \n(ENDISI)", y = "Occupancy", title = "") + #, title = "Community-average"
        theme(axis.text.x = element_text(face = "bold", size = 7), 
              axis.text.y = element_text(face = "bold", size = 7), 
              axis.title.x = element_text(face = "bold", size = 9), 
              axis.title.y = element_text(face = "bold", size = 9),
              legend.position = "none",
              legend.margin = margin(t = 5, r = 74, b = 5, l = 5, unit = "pt") ) 
      print(plot.tempint)
      
      ggsave("~/Github/caplter-dynamicbirds/figures/preds_urbXtemp/commpred_urb_temp.png",
       plot.tempint,
       width = 2,
       height = 2,
       units = "in",
       dpi = 300)
```


```{r urb predictions at two NDVI levels - community}
pred.VEG <- c(
  ((mean(env.spr$NDVI)-1*sd(env.spr$NDVI))-mean(env.spr$NDVI))/sd(env.spr$NDVI),
  0,
  ((mean(env.spr$NDVI)+1*sd(env.spr$NDVI))-mean(env.spr$NDVI))/sd(env.spr$NDVI)
  # (0.1155820-mean(env.spr$NDVI))/sd(env.spr$NDVI),
  # (0.2587979-mean(env.spr$NDVI))/sd(env.spr$NDVI)
  )
  # +/- 1 SD is roughly the same as using the 10th and 90th percentile values for 2001 to 2016
  # 0.1177186 and 0.252297 vs. 0.1155820 and 0.2587979
              # env.spr %>% pull(NDVI) %>% quantile(probs = c(0.1, 0.9))

              
# objects for storing prediction summary stats
    nline <- length(pred.VEG)
    preds.psi.mean <- rep(NA, npred*nline)
    preds.psi.med <- rep(NA, npred*nline)
    preds.psi.lowCI <- rep(NA, npred*nline)
    preds.psi.uppCI <- rep(NA, npred*nline)   


mcmc.beta <- tmp$beta.comm[samp,]
        
# predict across NDVI gradient
for(r in 1:nline){  
        # a design matrix 
        dm.urb <- cbind(
          1,
          urban.pred,  # urbanization
          0, #pred.TEMP[r],  # Temperature
          0, #pred.TEMP[r]*urb.pred,  # Temp*urbanization
          pred.VEG[r],  # Vegetation
          pred.VEG[r]*urban.pred  # Veg*urbanization
        )
        
        # mcmc.beta <- tmp$beta.comm
        
        preds.psi <- plogis(mcmc.beta %*% t(dm.urb))  # predict
        
        preds.psi.cri <- apply(preds.psi, 2, quantile, probs = c(0.05,0.5,0.95)) %>% t() %>% data.frame()
        
        preds.psi.mean[(r*npred-npred+1):(r*npred)] <- apply(preds.psi, c(2), function(x)   mean(x, na.rm=TRUE))    # posterior mean
        preds.psi.lowCI[(r*npred-npred+1):(r*npred)] <- preds.psi.cri[,1]
        preds.psi.med[(r*npred-npred+1):(r*npred)] <- preds.psi.cri[,2]
        preds.psi.uppCI[(r*npred-npred+1):(r*npred)] <- preds.psi.cri[,3]
        
        
  }
          
          
      data.pred.VEG.comm <- data.frame(
        "impervious" = rep(seq(min(env.model$ENDISIadj), max(env.model$ENDISIadj), length.out = npred), nline),
        "impervious_std" = rep(urban.pred, nline),
        "level" = rep(c("low", "mean", "high"), each = npred),
        "NDVI" = rep((pred.VEG*sd(env.model$NDVI)+mean(env.model$NDVI)), each = npred),
        "psi_med" = preds.psi.med,
        "psi_lowCI" = preds.psi.lowCI,
        "psi_uppCI" = preds.psi.uppCI
      )    
      
  
      
       plot.vegint <- data.pred.VEG.comm %>% 
         filter(level %in% c("low", "high")) %>%
         ggplot(aes(x = impervious, y = psi_med, group = level)) +
        theme_classic() + 
        geom_smooth(aes(x = impervious, y = psi_med, group = level, color = NDVI, linetype = as.factor(NDVI)),
                     method = "gam",  se = FALSE)+
        geom_ribbon(aes(x = impervious, y = psi_med, group = level, ymin = psi_lowCI, ymax = psi_uppCI, fill = NDVI), 
                    alpha = 0.4) + 
        scale_fill_distiller(palette = "BrBG", direction = 1)+
        scale_color_distiller(palette = "BrBG", direction = 1)+
        scale_y_continuous(labels = label_number(accuracy = 0.01)) +
        scale_linetype_manual(values = c(2, 1)) +
        coord_cartesian(ylim=c(0,0.05))+
        labs(x = "Urbanization \n(ENDISI)", y = "Occupancy", title = "") + 
        theme(axis.text.x = element_text(face = "bold", size = 7), 
              axis.text.y = element_text(face = "bold", size = 7), 
              axis.title.x = element_text(face = "bold", size = 9), 
              axis.title.y = element_text(face = "bold", size = 9),
              legend.position = "none",
              legend.margin = margin(t = 5, r = 74, b = 5, l = 5, unit = "pt") ) 
      print(plot.vegint)
      
      ggsave("~/Github/caplter-dynamicbirds/figures/preds_urbXveg/commpred_urb_veg.png",
       plot.vegint,
       width = 2,
       height = 2,
       units = "in",
       dpi = 300)
      
      data.pred.VEG.comm %>% 
        # filter(level %in% c("mean", "low")) %>% 
        arrange(impervious, level)
      # 0.022089846 -1SD veg, low urb
      # 0.028208432 mean veg, low urb
      # 0.035818850 +1SD veg, low urb
      # 0.005910614 -1SD veg, high urb
      # 0.005744220 mean veg, high urb
      # 0.005588851 +1SD veg, high urb
      
      (0.022089846-0.028208432)/0.028208432*100 # 22% decrease with -1SD
      (0.005910614-0.005744220)/0.005744220*100 # 3% increase with +1SD
      
      (0.035818850-0.028208432)/0.028208432*100 # 27% increase with +1SD
      (0.005588851-0.005744220)/0.005744220*100 # 3% decrease with +1SD
```


```{r urb predictions at two temperatures - species}
# how many temperature levels to predict across
pred.TEMP <- c(
  # (12.77778-mean(env.spr$temp_min))/sd(env.spr$temp_min), # 12.77778 C = 55
  (14.90144-mean(env.spr$temp_min))/sd(env.spr$temp_min), # mean minus 1 C
  (16.90144-mean(env.spr$temp_min))/sd(env.spr$temp_min)#, # mean plus 1 C
  # (18.3333-mean(env.spr$temp_min))/sd(env.spr$temp_min)  # 18.3333 C = 65 F
                )
                # roughly the range of temperatures from 2000-2022

# objects for storing prediction summary stats
    nline <- length(pred.TEMP)
    preds.psi.mean <- rep(NA, npred*nline)
    preds.psi.med <- rep(NA, npred*nline)
    preds.psi.lowCI <- rep(NA, npred*nline)
    preds.psi.uppCI <- rep(NA, npred*nline)   


spp.plot <- data.spp %>%
  # filter(common_name %in% c(
  #   spp.urb.negative
  #   # spp.urb.positive
  # )) %>%
  # filter(common_name %in% c(
  #   # spp.temp.negative,
  #   # spp.temp.positive,
  #   spp.tempint.negative,
  #   spp.tempint.positive
  # )) %>%
  pull(code)

# all the species with some effect
    # spp.plot <- data.spp %>% filter(!common_name %in% c(spp.neutral)) %>% pull(code)

data.pred.TEMP.list <- list()

   for (s in 1:length(spp.plot)){
        spp.name <- data.spp$common_name[which(data.spp$code == spp.plot[s])]
        mcmc.beta <- tmp$beta.species[samp,, which(dimnames(ysum.model)[[2]] == spp.plot[s])]
        # predict across NDVI gradient
      for(r in 1:nline){  
        
        dm.urb <- cbind(
          1,
          urban.pred,  # urbanization
          pred.TEMP[r], #pred.TEMP[r],  # Temperature
          pred.TEMP[r]*urban.pred, #pred.TEMP[r]*urban.pred,  # MAT*urbanization
          0, # pred.VEG[r],  # NDVI
          0# pred.VEG[r]*urban.pred  # NDVI*urbanization
        )
        
        # mcmc.beta <- tmp$beta.comm
        
        preds.psi <- plogis(mcmc.beta %*% t(dm.urb))  # predict
        
        preds.psi.cri <- apply(preds.psi, 2, quantile, probs = c(0.05,0.5,0.95)) %>% t() %>% data.frame()
        
        preds.psi.mean[(r*npred-npred+1):(r*npred)] <- apply(preds.psi, c(2), function(x)   mean(x, na.rm=TRUE))    # posterior mean
        preds.psi.lowCI[(r*npred-npred+1):(r*npred)] <- preds.psi.cri[,1]
        preds.psi.med[(r*npred-npred+1):(r*npred)] <- preds.psi.cri[,2]
        preds.psi.uppCI[(r*npred-npred+1):(r*npred)] <- preds.psi.cri[,3]
        
        
      }
          
          
      data.pred.TEMP.list[[s]] <- data.frame(
        "spp" = rep(spp.name, npred*nline),
        "impervious" = rep(seq(min(env.spr$ENDISIadj), max(env.spr$ENDISIadj), length.out = npred), nline),
        "impervious_std" = rep(urban.pred, nline),
        "level" = rep(c("low", "high"), each = npred),
        "temp_min" = rep((pred.TEMP*sd(env.spr$temp_min)+mean(env.spr$temp_min)), each = npred),
        "psi_med" = preds.psi.med,
        "psi_lowCI" = preds.psi.lowCI,
        "psi_uppCI" = preds.psi.uppCI
      )    
      
      # print(s)

   }  


data.pred.TEMP <- do.call(bind_rows, data.pred.TEMP.list)




```
```{r }
spp.plot <-  c(
    spp.temp.negative,
    spp.temp.positive,
    spp.tempint.negative,
    spp.tempint.positive
)

plot.tempint <- data.pred.TEMP %>% 
       filter(spp %in% spp.plot) %>%
       # filter(level == "low") %>%
       # filter(level == "high") %>%
       ggplot() +
      theme_classic() + 
       geom_smooth(data = filter(data.pred.TEMP, level == "low"), aes(x = impervious, y = psi_med, group = spp, color = temp_min, linetype = as.factor(temp_min)),
                   method = "gam", se = FALSE)+
      # geom_ribbon(aes(x = impervious, y = psi_med, group = spp, ymin = psi_lowCI, ymax = psi_uppCI, fill = temp_min),
      #             alpha = 0.4) +
  # geom_smooth(data = filter(data.pred.TEMP, level == "high"), aes(x = impervious, y = psi_med, group = spp, color = temp_min, linetype = as.factor(temp_min)),
  #                  method = "gam", se = FALSE)+
      # scale_fill_distiller(palette = "RdYlBu", direction = -1)+
      # scale_color_distiller(palette = "RdYlBu", direction = -1)+
      scale_y_continuous(labels = label_number(accuracy = 0.01)) +
      scale_linetype_manual(values = c(2, 1)) +
      coord_cartesian(ylim=c(0,1))+
      labs(x = "Urbanization \n(ENDISI)", y = "Occupancy", title = "") +
      theme(axis.text.x = element_text(face = "bold", size = 14), 
            axis.text.y = element_text(face = "bold", size = 14), 
            axis.title.x = element_text(face = "bold", size = 18), 
            axis.title.y = element_text(face = "bold", size = 18),
            legend.position = "none",
            legend.margin = margin(t = 5, r = 74, b = 5, l = 5, unit = "pt") ) 
plot.tempint

data.pred.TEMP %>% 
       filter(spp == spp.plot) %>%
       # filter(level == "low") %>%
       filter(level == "high") %>%
       ggplot() +
      theme_classic() + 
       # geom_smooth(data = filter(data.pred.TEMP, level == "low"), aes(x = impervious, y = psi_med, group = spp, color = temp_min, linetype = as.factor(temp_min)),
       #             method = "gam", se = FALSE)+
      # geom_ribbon(aes(x = impervious, y = psi_med, group = spp, ymin = psi_lowCI, ymax = psi_uppCI, fill = temp_min),
      #             alpha = 0.4) +
  geom_smooth(data = filter(data.pred.TEMP, level == "high"), aes(x = impervious, y = psi_med, group = spp, color = temp_min, linetype = as.factor(temp_min)),
                   method = "gam", se = FALSE)+
      # scale_fill_distiller(palette = "RdYlBu", direction = -1)+
      # scale_color_distiller(palette = "RdYlBu", direction = -1)+
      scale_y_continuous(labels = label_number(accuracy = 0.01)) +
      scale_linetype_manual(values = c(2, 1)) +
      coord_cartesian(ylim=c(0,1))+
      labs(x = "Urbanization \n(ENDISI)", y = "Occupancy", title = "") +
      theme(axis.text.x = element_text(face = "bold", size = 14), 
            axis.text.y = element_text(face = "bold", size = 14), 
            axis.title.x = element_text(face = "bold", size = 18), 
            axis.title.y = element_text(face = "bold", size = 18),
            legend.position = "none",
            legend.margin = margin(t = 5, r = 74, b = 5, l = 5, unit = "pt") )
```

```{r plot temperature predictions for individual temp sensitive species}

spp.plot <- c(
  "RWBL",
  "BCNH",
  "AMKE",
  "MODO",
  "WWDO"#,
  # "GAQU",
  # "LBWO",
  # "CACW",
  # "PHAI",
  # "BAEA",
  # "ANHU",
  # "CBTH"
)

spp.plot <- data.spp %>%
  # filter(common_name %in% c(
  #   spp.urb.negative
  #   # spp.urb.positive
  # )) %>%
  filter(common_name %in% c(
    spp.temp.negative,
    spp.temp.positive,
    spp.tempint.negative,
    spp.tempint.positive
  )) %>%
  pull(code)

for(s in 1:length(spp.plot)){
  spp.name <- data.spp$common_name[which(data.spp$code == spp.plot[s])]
     
     plot.tempint <- data.pred.TEMP %>% 
       filter(spp == spp.name) %>%
       ggplot(aes(x = impervious, y = psi_med, group = level)) +
      theme_classic() + 
       geom_smooth(aes(x = impervious, y = psi_med, group = level, color = temp_min, linetype = as.factor(temp_min)),
                   method = "gam", se = FALSE)+
      geom_ribbon(aes(x = impervious, y = psi_med, group = level, ymin = psi_lowCI, ymax = psi_uppCI, fill = temp_min), 
                  alpha = 0.4) + 
      scale_fill_distiller(palette = "RdYlBu", direction = -1)+
      scale_color_distiller(palette = "RdYlBu", direction = -1)+
      scale_y_continuous(labels = label_number(accuracy = 0.01)) +
      scale_linetype_manual(values = c(2, 1)) +
      # coord_cartesian(ylim=c(0,1))+
      labs(x = "Urbanization \n(ENDISI)", y = "Occupancy", title = spp.name) +
      theme(axis.text.x = element_text(face = "bold", size = 7), 
            axis.text.y = element_text(face = "bold", size = 7), 
            axis.title.x = element_text(face = "bold", size = 9), 
            axis.title.y = element_text(face = "bold", size = 9),
            title = element_text(size = 7),
            legend.position = "none",
            legend.margin = margin(t = 5, r = 74, b = 5, l = 5, unit = "pt") ) 
    print(plot.tempint)
    
    ggsave(paste(paste("~/Github/caplter-dynamicbirds/figures/preds_urbXtemp/spppred_urb_temp_", spp.plot[s], sep = ""), ".png", sep = ""),
     plot.tempint,
     width = 2,
     height = 2,
     units = "in",
     dpi = 300)
}
```

```{r urb predictions at two NDVI levels - species}
# how many NDVI levels to predict across
    plot(env.spr$ENDISIadj, env.spr$NDVI)
    # at the moderately high urbanization sites, NDVI doesn't ever get above 0.3
    # the NDVI of the most urbanized sites is between 0 and 0.1
    
pred.VEG <- c(
  ((mean(env.spr$NDVI)-1*sd(env.spr$NDVI))-mean(env.spr$NDVI))/sd(env.spr$NDVI),
  # 0,
  ((mean(env.spr$NDVI)+1*sd(env.spr$NDVI))-mean(env.spr$NDVI))/sd(env.spr$NDVI)
  )
  # +/- 1 SD is roughly the same as using the 10th and 90th percentile values for 2001 to 2016
  # 0.1177186 and 0.252297 vs. 0.1155820 and 0.2587979
              # env.spr %>% pull(NDVI) %>% quantile(probs = c(0.1, 0.9))


# objects for storing prediction summary stats
    nline <- length(pred.VEG)
    preds.psi.mean <- rep(NA, npred*nline)
    preds.psi.med <- rep(NA, npred*nline)
    preds.psi.lowCI <- rep(NA, npred*nline)
    preds.psi.uppCI <- rep(NA, npred*nline)   


spp.plot <- c(
  "PHAI",
  "BAEA",
  "ANHU",
  "CBTH"
)

spp.plot <- data.spp %>%
  # filter(common_name %in% c(
  #   # spp.urb.negative
  #   spp.urb.positive
  # )) %>%
  # filter(common_name %in% c(
  # # spp.veg.negative,
  # spp.veg.positive,
  # # spp.vegint.negative#,
  # # spp.vegint.positive
  # )) %>%
  pull(code)

# all the species with some effect
    # spp.plot <- data.spp %>% filter(!common_name %in% c(spp.neutral)) %>% pull(code)

data.pred.VEG.list <- list()

 for (s in 1:length(spp.plot)){
        spp.name <- data.spp$common_name[which(data.spp$code == spp.plot[s])]
        mcmc.beta <- tmp$beta.species[samp,, which(dimnames(ysum.model)[[2]] == spp.plot[s])]
        
        # predict across NDVI gradient
      for(r in 1:nline){ 
        # a design matrix
        dm.urb <- cbind(
          1,
          urban.pred,  # urbanization
          0, #pred.TEMP[r],  # Temperature
          0, #pred.TEMP[r]*urb.pred,  # Temp*urbanization
          pred.VEG[r],  # Vegetation
          pred.VEG[r]*urban.pred  # Veg*urbanization
        )
        
        # mcmc.beta <- tmp$beta.comm
        
        preds.psi <- plogis(mcmc.beta %*% t(dm.urb))  # predict
        
        preds.psi.cri <- apply(preds.psi, 2, quantile, probs = c(0.025,0.5,0.975)) %>% t() %>% data.frame()
        
        preds.psi.mean[(r*npred-npred+1):(r*npred)] <- apply(preds.psi, c(2), function(x)   mean(x, na.rm=TRUE))    # posterior mean
        preds.psi.lowCI[(r*npred-npred+1):(r*npred)] <- preds.psi.cri[,1]
        preds.psi.med[(r*npred-npred+1):(r*npred)] <- preds.psi.cri[,2]
        preds.psi.uppCI[(r*npred-npred+1):(r*npred)] <- preds.psi.cri[,3]
        
      }
          
          
      data.pred.VEG.list[[s]] <- data.frame(
        "spp" = rep(spp.name, npred*nline),
        "impervious" = rep(seq(min(env.model$ENDISIadj), max(env.model$ENDISIadj), length.out = npred), nline),
        "impervious_std" = rep(urban.pred, nline),
        "level" = rep(c("low", "high"), each = npred),
        #"NDVI" = rep(env.model$NDVI, each = npred),
        "NDVI" = rep((pred.VEG*sd(env.model$NDVI)+mean(env.model$NDVI)), each = npred),
        "psi_med" = preds.psi.med,
        "psi_mean" = preds.psi.mean,
        "psi_lowCI" = preds.psi.lowCI,
        "psi_uppCI" = preds.psi.uppCI
      )    
      
      
      # print(s)
       
 }

data.pred.VEG <- do.call(bind_rows, data.pred.VEG.list)
      
```
```{r plot veg predictions for veg sensitive species}
spp.plot <- data.spp%>% 
  # filter(common_name %in% c(
  #   # spp.urb.negative
  #   spp.urb.positive
  # )) %>% 
  filter(common_name %in% c(
    spp.veg.negative,
    spp.veg.positive,
    spp.vegint.negative,
    spp.vegint.positive
  )) %>%
  pull(code)

for(s in 1:length(spp.plot)){
  spp.name <- data.spp$common_name[which(data.spp$code == spp.plot[s])]
     
     plot.vegint <- data.pred.VEG %>% 
       filter(spp == spp.name) %>%
         ggplot(aes(x = impervious, y = psi_med, group = level)) +
        theme_classic() + 
        geom_smooth(aes(x = impervious, y = psi_med, group = level, color = NDVI, linetype = as.factor(NDVI)),
                     method = "gam",  se = FALSE)+
        geom_ribbon(aes(x = impervious, y = psi_med, group = level, ymin = psi_lowCI, ymax = psi_uppCI, fill = NDVI), 
                    alpha = 0.4) + 
        scale_fill_distiller(palette = "BrBG", direction = 1)+
        scale_color_distiller(palette = "BrBG", direction = 1)+
        scale_y_continuous(labels = label_number(accuracy = 0.01)) +
        scale_linetype_manual(values = c(2, 1)) +
        # coord_cartesian(ylim=c(0,1))+
        labs(x = "Urbanization \n(ENDISI)", y = "Occupancy", title = spp.name) +
        theme(axis.text.x = element_text(face = "bold", size = 7), 
              axis.text.y = element_text(face = "bold", size = 7), 
              axis.title.x = element_text(face = "bold", size = 9), 
              axis.title.y = element_text(face = "bold", size = 9),
              title = element_text(size = 7), 
              legend.position = "none",
              legend.margin = margin(t = 5, r = 74, b = 5, l = 5, unit = "pt") ) 
      # print(plot.vegint)
      # range(data.plot$EVI)
      
      ggsave(paste(paste("~/Github/caplter-dynamicbirds/figures/preds_urbXveg/spppred_urb_veg_", spp.plot[s], sep = ""), ".png", sep = ""),
       plot.vegint,
       width = 2,
       height = 2,
       units = "in",
       dpi = 300)
}
```


# Urbanization, Temperature, and Vegetation Trends
```{r urbanization trend}
#
kruskal.test(ENDISIadj ~ survey_year, data = (env.model %>% filter(season == "2_spring")))

gam(ENDISIadj ~ survey_year, data = (env.model %>% filter(season == "2_spring"))) %>% summary()

(plot.trend <- env.model %>% filter(!season == "annual") %>% 
    filter(season %in% c("2_spring")) %>%
    reframe(mean = mean(ENDISIadj), median = median(ENDISIadj),
                                    sd = sd(ENDISIadj), se = sd(ENDISIadj)/sqrt(length(ENDISIadj)), 
                                    .by = c(survey_year, season)) %>%
  ggplot(aes(x = survey_year, y = mean, group = season, color = season)) +
  geom_errorbar(aes(ymin = (mean-1.96*se), ymax = (mean+1.96*se)), width = 0.4, size = 0.4, position = position_dodge(width = 0.5),
                alpha = 0.5) +
  geom_point(shape = 16, position = position_dodge(width = 0.5)) +
  geom_line(linewidth = 0.5, position = position_dodge(width = 0.5)) +
  scale_color_brewer(palette = "Dark2") +
  # scale_color_manual(values = pal_season) +
  scale_y_continuous(labels = label_number(accuracy = 0.01)) +
  # stat_cor(method = "spearman", cor.coef.name = "rho", p.accuracy = 0.001, r.accuracy = 0.001, color = "black") +
  # coord_cartesian(ylim = c(0,30)) +
  labs(x = "Year", y = "Urbanization\n(ENDISI)") +
  theme_bw()+
    theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 30, vjust = 1, hjust=1, size = 14),
    axis.text.y = element_text(size = 14),
    axis.title = element_text(face = "bold", size = 16)
  ))


(plot.trend <- env.model %>% filter(!season == "annual") %>% 
    filter(season %in% c("2_spring")) %>%
    ggplot(aes(x = survey_year, y = ENDISIadj, group = season, color = season)) +
    geom_point(alpha = 0.1, shape = 16, position = position_dodge(width = 0.6), color = "purple3") +
    geom_smooth(method = "gam", se = FALSE, color = "purple3") +
    # scale_color_brewer(palette = "Dark2") +
    #scale_color_manual(values = pal_season) +
    # coord_cartesian(ylim = c(0.05, 0.45)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    # stat_cor(method = "spearman", cor.coef.name = "rho", p.accuracy = 0.001, r.accuracy = 0.001, color = "black") +
    # stat_cor(method = "pearson", cor.coef.name = "r", p.accuracy = 0.001, r.accuracy = 0.001, color = "black") +
    labs(x = "Year", y = "Urbanization\n(ENDISI)") +
    theme_bw()+
    theme(
        # legend.position = "none",
        axis.text.x = element_text(angle = 30, vjust = 1, hjust=1, size = 8),
        axis.text.y = element_text(size = 8),
        axis.title = element_text(face = "bold", size = 8)
    ))


ggsave("~/Github/caplter-dynamicbirds/figures/trends_env/env_ENDISIadj_birdsites_01to16.png",
       plot.trend,
       width = 2,
       height = 2,
       units = "in",
       dpi = 300)

```

```{r temperature trend}
env.model %>% reframe(
  temp_min = mean(temp_min),
  temp_max = mean(temp_max),
  .by = c(season)
)

kruskal.test(temp_min ~ survey_year, data = (env.model %>% filter(season == "2_spring")))

gam(temp_min ~ survey_year, data = (env.model %>% filter(season == "2_spring"))) %>% summary()

# Temperature
(plot.trend <- env.model %>% filter(!season == "annual") %>% 
    filter(season %in% c("2_spring")) %>%
    reframe(mean = mean(temp_min), median = median(temp_min),
                                    sd = sd(temp_min), se = sd(temp_min)/sqrt(length(temp_min)), 
                                    .by = c(survey_year, season)) %>%
  ggplot(aes(x = survey_year, y = mean, group = season, color = season)) +
  geom_errorbar(aes(ymin = (mean-1.96*se), ymax = (mean+1.96*se)), width = 0.4, size = 0.4, position = position_dodge(width = 0.5),
                alpha = 0.5) +
  geom_point(shape = 16, position = position_dodge(width = 0.5)) +
  geom_line(linewidth = 0.5, position = position_dodge(width = 0.5)) +
  scale_color_brewer(palette = "Dark2") +
  # scale_color_manual(values = pal_season) +
  scale_y_continuous(labels = label_number(accuracy = 0.01)) +
  # stat_cor(method = "spearman", cor.coef.name = "rho", p.accuracy = 0.001, r.accuracy = 0.001, color = "black") +
  # coord_cartesian(ylim = c(0,30)) +
  labs(x = "Year", y = "Daily Minimum Air\nTemperature (°C)") +
  theme_bw()+
    theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 30, vjust = 1, hjust=1, size = 14),
    axis.text.y = element_text(size = 14),
    axis.title = element_text(face = "bold", size = 16)
  ))


(plot.trend <- env.model  %>% filter(!season == "annual") %>% 
     filter(season %in% c("2_spring")) %>%
     ggplot(aes(x = survey_year, y = temp_min, group = season)) +
     geom_point(alpha = 0.1, shape = 16, position = position_dodge(width = 0.6), color = "red3") +
     geom_smooth(method = "gam", se = FALSE, color = "red3") +
     # scale_color_brewer(palette = "Dark2") +
     #scale_color_manual(values = pal_season) +
     scale_y_continuous(labels = label_number(accuracy = 0.1)) +
     # stat_cor(method = "spearman", cor.coef.name = "rho", p.accuracy = 0.001, r.accuracy = 0.001, color = "black") +
     # stat_cor(method = "pearson", cor.coef.name = "r", p.accuracy = 0.001, r.accuracy = 0.001, color = "black") +
     labs(x = "Year", y = "Daily Minimum Air \nTemperature (°C)") +
     theme_bw()+
     theme(
         # legend.position = "none",
         axis.text.x = element_text(angle = 30, vjust = 1, hjust=1, size = 8),
         axis.text.y = element_text(size = 8),
         axis.title = element_text(face = "bold", size = 8)
     ))


ggsave("~/Github/caplter-dynamicbirds/figures/trends_env/env_tempmin_birdsites_01to16.png",
       plot.trend,
       width = 2,
       height = 2,
       units = "in",
       dpi = 300)

```

```{r veg trend} 
kruskal.test(NDVI ~ survey_year, data = (env.model %>% filter(season == "2_spring")))

gam(NDVI ~ survey_year, data = (env.model %>% filter(season == "2_spring"))) %>% summary()

# NDVI
(plot.trend <- env.model %>% filter(!season == "annual") %>% 
    filter(season %in% c("2_spring")) %>%
    reframe(mean = mean(NDVI), median = median(NDVI),
                                    sd = sd(NDVI), se = sd(NDVI)/sqrt(length(NDVI)), 
                                    .by = c(survey_year, season)) %>%
  ggplot(aes(x = survey_year, y = mean, group = season, color = season)) +
  geom_errorbar(aes(ymin = (mean-1.96*se), ymax = (mean+1.96*se)), width = 0.4, size = 0.4, position = position_dodge(width = 0.5),
                alpha = 0.5) +
  geom_point(shape = 16, position = position_dodge(width = 0.5)) +
  geom_line(linewidth = 0.5, position = position_dodge(width = 0.5)) +
  scale_color_brewer(palette = "Dark2") +
  # scale_color_manual(values = pal_season) +
  scale_y_continuous(labels = label_number(accuracy = 0.01)) +
  # stat_cor(method = "spearman", cor.coef.name = "rho", p.accuracy = 0.001, r.accuracy = 0.001, color = "black") +
  # coord_cartesian(ylim = c(0,30)) +
  labs(x = "Year", y = "Vegetation\n(NDVI)") +
  theme_bw()+
    theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 30, vjust = 1, hjust=1, size = 14),
    axis.text.y = element_text(size = 14),
    axis.title = element_text(face = "bold", size = 16)
  ))




(plot.trend <- env.model %>% filter(!season == "annual") %>% 
    filter(season %in% c("2_spring")) %>%
    ggplot(aes(x = survey_year, y = NDVI, group = season, color = season)) +
    geom_point(alpha = 0.1, shape = 16, position = position_dodge(width = 0.6), color = "green3") +
    geom_smooth(method = "gam", se = FALSE, color = "green3") +
    # scale_color_brewer(palette = "Dark2") +
    #scale_color_manual(values = pal_season) +
    # coord_cartesian(ylim = c(0.05, 0.45)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    # stat_cor(method = "spearman", cor.coef.name = "rho", p.accuracy = 0.001, r.accuracy = 0.001, color = "black") +
    # stat_cor(method = "pearson", cor.coef.name = "r", p.accuracy = 0.001, r.accuracy = 0.001, color = "black") +
    labs(x = "Year", y = "Vegetation\n(NDVI)") +
    theme_bw()+
    theme(
        # legend.position = "none",
        axis.text.x = element_text(angle = 30, vjust = 1, hjust=1, size = 8),
        axis.text.y = element_text(size = 8),
        axis.title = element_text(face = "bold", size = 8)
    ))

ggsave("~/Github/caplter-dynamicbirds/figures/trends_env/env_NDVI_birdsites_01to16.png",
       plot.trend,
       width = 2,
       height = 2,
       units = "in",
       dpi = 300)
```



# BONUS CODE

```{r urbanization effects by popularity}
plot.effects <- m.effects.sum %>%
ggplot(aes(x = as.factor(order_urbeffect), y = median_effect_urb, color = congruence)) +
  theme_classic() +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  geom_linerange(aes(ymin = low90_effect_urb, ymax = upp90_effect_urb), 
                 width = 0.4, size = 0.4, alpha = 1)+
  geom_point(pch = 16, size = 1) +   #pch = 21, fill = NA
  # geom_pointrange(aes(ymin = low90_effect_urb, ymax = upp90_effect_urb)) +
  scale_x_discrete(labels = m.effects.sum$spp) +
  scale_color_viridis_c(option = "viridis", direction = 1) +
  labs(x = "Species", y = "Relationship with Impervious \nSurface (ENDISI)", color = "Regional \nPopularity") + 
  # gghighlight(SGCN %in% c("1", "2", "3")) +
  # gghighlight(spp %in% c("BETH")) +
  # gghighlight(spp %in% c(m.effects.sum %>% filter(low90_effect_urb > 0) %>% pull(spp))) +
  theme(
    # legend.position = "none",
    # axis.text.x = element_text(angle = 30, vjust = 1, hjust=1, size = 14),
    axis.text.x = element_blank(),
    axis.text.y = element_text(size = 14),
    axis.title = element_text(face = "bold", size = 16),
    legend.title = element_text(face = "bold", size = 16),
    legend.text = element_text(size = 14)
  )
plot.effects

ggsave("~/Github/caplter-dynamicbirds/figures/effect_urb_congruence.png",
       plot.effects,
       width = 7,
       height = 4,
       units = "in",
       dpi = 300)

```
```{r urbanization effects by cultural niche}
plot.effects <- m.effects.sum %>%
ggplot(aes(x = as.factor(order_urbeffect), y = median_effect_urb, color = as.factor(cultural_niche))) +
  theme_classic() +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  geom_linerange(aes(ymin = low90_effect_urb, ymax = upp90_effect_urb), size = 0.4, alpha = 1)+
  geom_point(pch = 16, size = 1) +   #pch = 21, fill = NA
  # geom_pointrange(aes(ymin = low90_effect_urb, ymax = upp90_effect_urb)) +
  scale_x_discrete(labels = m.effects.sum$spp) +
  # scale_color_viridis_c(option = "viridis", direction = 1) +
  labs(x = "Species", y = "Relationship with Impervious \nSurface (ENDISI)", 
       color = "Cultural \nNiche") + 
  gghighlight(cultural_niche %in% c("Celebrity", "Friend", "Neighbor", "Stranger")) +
  theme(
    # legend.position = "none",
    # axis.text.x = element_text(angle = 30, vjust = 1, hjust=1, size = 14),
    axis.text.x = element_blank(),
    axis.text.y = element_text(size = 14),
    axis.title = element_text(face = "bold", size = 16),
    legend.title = element_text(face = "bold", size = 16),
    legend.text = element_text(size = 14)
  )
plot.effects

# ggsave("~/Github/caplter-dynamicbirds/figures/effect_urb_culturalniche.png",
#        plot.effects,
#        width = 7,
#        height = 4,
#        units = "in",
#        dpi = 300)

```
```{r urb vs temp effects by cultural traits}



data.spp %>% filter(common_name %in% spp.urb.negative) %>% select(c(common_name, cultural_niche)) %>%
  arrange (cultural_niche)
data.spp %>% filter(common_name %in% spp.urb.positive) %>% select(c(common_name, cultural_niche)) %>%
  arrange (cultural_niche)

m.effects.sum %>%
ggplot(aes(x = median_effect_urb, y = median_effect_temp, color = as.factor(cultural_niche))) + #
  theme_classic() +
  # scale_x_discrete(labels = m.effects.sum$spp) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed") +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  geom_point() +
  geom_errorbar(aes(xmin = low90_effect_urb, xmax = upp90_effect_urb), alpha = 0.2) +
  geom_errorbar(aes(ymin = low90_effect_temp, ymax = upp90_effect_temp), alpha = 0.2) +
  labs(x = "Relationship with Urbanization (ENDISI)", y = "Relationship with Temperature \n(Daily Minimum)") + 
  # gghighlight(SGCN %in% c("1", "2", "3")) +
  # gghighlight(spp %in% c("BETH")) +
  gghighlight(common_name %in% c(spp.urb.negative, spp.urb.positive#,
                         # spp.temp.negative, spp.temp.positive,
                         # spp.tempint.negative, spp.tempint.positive
                         )) +
  # gghighlight(spp %in% c(m.effects.sum %>% filter(upp90_effect_urb < 0) %>% pull(spp))) +
  theme(
    # axis.text.x = element_blank()
  )


m.effects.sum %>%
ggplot(aes(x = median_effect_urb, y = median_effect_temp, fill = popularity, color = popularity)) + #
  theme_classic() +
  # scale_x_discrete(labels = m.effects.sum$spp) +
  scale_color_distiller(palette = "YlGnBu", direction = 1)+
  scale_fill_distiller(palette = "YlGnBu", direction = 1)+
  geom_vline(xintercept = 0, color = "black", linetype = "dashed") +
  geom_hline(yintercept = 0, color = "black", linetype = "dashed") +
  geom_errorbar(aes(xmin = low90_effect_urb, xmax = upp90_effect_urb), alpha = 1) +
  geom_errorbar(aes(ymin = low90_effect_temp, ymax = upp90_effect_temp), alpha = 1) +
  labs(x = "Relationship with Urbanization (ENDISI)", y = "Relationship with Temperature \n(Daily Minimum)") + 
  geom_point(pch = 21) +
  # gghighlight(SGCN %in% c("1", "2", "3")) +
  # gghighlight(spp %in% c("BETH")) +
  gghighlight(common_name %in% c(spp.urb.negative, spp.urb.positive#,
                         # spp.temp.negative, spp.temp.positive,
                         # spp.tempint.negative, spp.tempint.positive
                         )) +
  # gghighlight(spp %in% c(m.effects.sum %>% filter(upp90_effect_urb < 0) %>% pull(spp))) +
  theme(
    # axis.text.x = element_blank()
  )

```
```{r OTHER TEMP and NDVI trends}


(plot.trend <- env.model  %>% filter(!season == "annual") %>% #filter(season %in% c("1_winter", "2_spring")) %>%
     ggplot(aes(x = survey_year, y = LST, group = season, color = season)) +
     geom_point(alpha = 0.3, shape = 16, position = position_dodge(width = 0.6)) +
     geom_smooth(method = "gam", se = FALSE) +
     # scale_color_brewer(palette = "Dark2") +
     #scale_color_manual(values = pal_season) +
     # stat_cor(method = "spearman", cor.coef.name = "rho", p.accuracy = 0.001, r.accuracy = 0.001, color = "black") +
     labs(x = "Year", y = "Temperature (°C)") +
     theme_bw()+
     theme(
         # legend.position = "none",
         axis.text.x = element_text(angle = 30, vjust = 1, hjust=1, size = 16),
         axis.text.y = element_text(size = 16),
         axis.title = element_text(face = "bold", size = 16)
     ))


(plot.trend <- env.model %>% filter(!season == "annual") %>% 
    filter(season %in% c("2_spring")) %>%
    reframe(mean = mean(NDVI), median = median(NDVI),
                                    sd = sd(NDVI), se = sd(NDVI)/sqrt(length(NDVI)), 
                                    .by = c(survey_year, season)) %>%
  ggplot(aes(x = survey_year, y = mean, group = season, color = season)) +
  geom_errorbar(aes(ymin = (mean-1.96*se), ymax = (mean+1.96*se)), width = 0.4, size = 0.4, position = position_dodge(width = 0.5),
                alpha = 0.5) +
  geom_point(shape = 16, position = position_dodge(width = 0.5)) +
  geom_line(linewidth = 0.5, position = position_dodge(width = 0.5)) +
  scale_color_brewer(palette = "Dark2") +
  # scale_color_manual(values = pal_season) +
  scale_y_continuous(labels = label_number(accuracy = 0.01)) +
  # stat_cor(method = "spearman", cor.coef.name = "rho", p.accuracy = 0.001, r.accuracy = 0.001, color = "black") +
  # coord_cartesian(ylim = c(0,30)) +
  labs(x = "Year", y = "Vegetation (NDVI)") +
  theme_bw()+
    theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 30, vjust = 1, hjust=1, size = 14),
    axis.text.y = element_text(size = 14),
    axis.title = element_text(face = "bold", size = 16)
  ))
```



```{r species richness}
str(tmp$Z)

(tmp$rich)[1]
tmp

data.plot <- data.frame(
  "site" = rep(rep(dimnames(ysum.model)[[1]], each = dim(tmp$rich)[1]), dim(ysum.model)[[3]]),
  "year" = as.numeric(rep(rep(dimnames(ysum.model)[[3]], each = dim(tmp$rich)[1]), each = dim(ysum.model)[[1]])),
  "estimate" = matrix(tmp$rich)
) %>% mutate(
  mean = mean(estimate), 
  median = median(estimate),
  low95 = quantile(estimate, probs = c(0.025)),
  upp95 = quantile(estimate, probs = c(0.975)),
  .by = c(site, year)) %>% 
  group_by(year) %>% arrange(year, mean, site) %>% ungroup() %>%   # rank sites by mean richness during each year
  # mutate(order_mean = as.factor(rep(1:(dim(tmp$rich)[3]*dim(tmp$rich)[2]), each = dim(tmp$rich)[1])))
  mutate(order_mean = rep(rep(1:(dim(tmp$rich)[2]), each = dim(tmp$rich)[1]), dim(tmp$rich)[3])) 

data.plot.sum <- data.plot %>% group_by(site, year) %>% slice(1) %>% select(-c(estimate)) %>% ungroup()

data.plot %>% filter(year %in% c(2001, 2008, 2016)) %>%
ggplot(aes(x = estimate, y = order_mean, group = order_mean)) +
  facet_grid(rows = vars(year)) +
  theme_bw() +
  geom_density_ridges(alpha = 0.7, color = "transparent") +
  coord_flip() +
  # scale_y_discrete(labels = data.plot.sum$spp) +
  geom_pointrange(aes(x = mean, xmin = low95, xmax = upp95)) +
  labs(x = "Alpha Diversity (Species Richness)", y = "Site (ordered by mean richness per season)") +
  # coord_flip() +
  theme(
    # axis.text.x = element_blank()
  )
  
ggplot(data.plot.sum, aes(x = as.factor(year), y = mean)) +
  geom_boxplot()

ggplot(data.plot.sum, aes(x = year, y = mean, colour = site, fill = site)) +
  # scale_x_discrete(labels = data.plot$spp) +
  # geom_point(aes(x = year, y = mean)) +
  geom_pointrange(aes(ymin = low95, ymax = upp95), position = position_dodge2(width = 0.5)) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Species (Alpha-code)", y = "Species Richness") + 
  theme(
    legend.position = "none"
  )
             

```
